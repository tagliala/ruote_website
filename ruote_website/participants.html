<!DOCTYPE html>
<html><head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<title>ruote - testing participants</title>
<script src='/js/shCore.js'></script>
<script src='/js/shBrushXml.js'></script>
<script src='/js/shBrushBash.js'></script>
<script src='/js/shBrushRuby.js'></script>
<script src='/js/shBrushJScript.js'></script>
<!-- %script{ :src => "/js/jquery-1.6.1.min.js" } -->
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
<link href='/css/reset.css' rel='stylesheet' type='text/css'>
<link href='/css/shCore.css' rel='stylesheet' type='text/css'>
<link href='/css/shThemeRuote.css' rel='stylesheet' type='text/css'>
<link href='/css/ruote.css' rel='stylesheet' type='text/css'>
</head><body>
<div id='container'>
<div id='header'>
<div id='header-center'>
<div id='header-left'>
<a href='/'>
<img src='/images/ruote.png'>
</a>
<div id='header-subtitle'>
a ruby workflow engine
</div>
</div>
<div id='header-right'>
<div id='nav'>
<span>
<a href='/documentation.html' title='documentation'>
doc
</a>
<a href='/source.html' title='source code'>
source
</a>
<a href='/download.html' title='download'>
download
</a>
<a class='nihongo' href='/ja.html' title='日本語'>
日本語
</a>
</span>
</div>
</div>
</div>
</div>
<div id='content'>
<div id='content-center'>
<div id='sidebar'><h3 onclick='document.location = &quot;/documentation.html&quot;' style='cursor: pointer'>
Documentation
</h3>
<ul>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branches expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branches
</a>
</li>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branch
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/apply.html'>
apply expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/apply.html'>
apply
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/await.html'>
await expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/await.html'>
await
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/block_participant.html'>
block_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
cancel_process expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
cancel_process
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
terminate
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
kill_process
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/code_participant.html'>
code_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
command expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/command.html'>
skip
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
back
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
jump
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
rewind
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
continue
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
break
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
stop
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
over
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
reset
</a>
</li>
</ul>
<li>
<a href='/ruote_website/common_attributes.html'>
common attributes
</a>
</li>
<li>
<a href='/ruote_website/exp/concurrence.html'>
concurrence expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/concurrence.html'>
concurrence
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
concurrent_iterator expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
concurrent_iterator
</a>
</li>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
citerator
</a>
</li>
</ul>
<li>
<a href='/ruote_website/conditions.html'>
conditions
</a>
</li>
<li>
<a href='/ruote_website/configuration.html'>
configuration
</a>
</li>
<li>
<a href='/ruote_website/exp/cron.html'>
cron expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cron.html'>
cron
</a>
</li>
<li>
<a href='/ruote_website/exp/cron.html'>
every
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/cursor.html'>
cursor expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cursor.html'>
cursor
</a>
</li>
<li>
<a href='/ruote_website/exp/cursor.html'>
loop
</a>
</li>
<li>
<a href='/ruote_website/exp/cursor.html'>
repeat
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/decision_participant.html'>
decision_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/define.html'>
define expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/define.html'>
define
</a>
</li>
<li>
<a href='/ruote_website/exp/define.html'>
process_definition
</a>
</li>
<li>
<a href='/ruote_website/exp/define.html'>
workflow_definition
</a>
</li>
</ul>
<li>
<a href='/ruote_website/documentation.html'>
documentation
</a>
</li>
<li>
<a href='/ruote_website/dollar.html'>
dollar notation
</a>
</li>
<li>
<a href='/ruote_website/download.html'>
download
</a>
</li>
<li>
<a href='/ruote_website/exp/echo.html'>
echo expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/echo.html'>
echo
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/engine_participant.html'>
engine_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/equals.html'>
equals expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/equals.html'>
equals
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/error.html'>
error expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/error.html'>
error
</a>
</li>
</ul>
<li>
<a href='/ruote_website/expressions.html'>
expressions
</a>
</li>
<li>
<a href='/ruote_website/exp/filter.html'>
filter expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/filter.html'>
filter
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/forget.html'>
forget expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/forget.html'>
forget
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/given.html'>
given expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/given.html'>
given
</a>
</li>
</ul>
<li>
<a href='/ruote_website/glossary.html'>
glossary
</a>
</li>
<li>
<a href='/ruote_website/exp/if.html'>
if expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/if.html'>
if
</a>
</li>
</ul>
<li>
<a href='/ruote_website/implementing_a_storage.html'>
implementing a storage
</a>
</li>
<li>
<a href='/ruote_website/implementing_participants.html'>
implementing participants
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
inc expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/inc.html'>
inc
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
dec
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
increment
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
decrement
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
push
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
pop
</a>
</li>
</ul>
<li>
<a href='/ruote_website.html'>
index
</a>
</li>
<li>
<a href='/ruote_website/exp/iterator.html'>
iterator expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/iterator.html'>
iterator
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/let.html'>
let expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/let.html'>
let
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/listen.html'>
listen expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/listen.html'>
listen
</a>
</li>
<li>
<a href='/ruote_website/exp/listen.html'>
receive
</a>
</li>
<li>
<a href='/ruote_website/exp/listen.html'>
intercept
</a>
</li>
</ul>
<li>
<a href='/ruote_website/lists.html'>
lists
</a>
</li>
<li>
<a href='/ruote_website/part/local_participant.html'>
local_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/lose.html'>
lose expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/lose.html'>
lose
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/no_op_participant.html'>
no_op_participant
</a>
</li>
<li>
<a href='/ruote_website/noisy.html'>
noisy output
</a>
</li>
<li>
<a href='/ruote_website/exp/noop.html'>
noop expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/noop.html'>
noop
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/null_participant.html'>
null_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/on_error.html'>
on_error expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/on_error.html'>
on_error
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/once.html'>
once expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/once.html'>
once
</a>
</li>
<li>
<a href='/ruote_website/exp/once.html'>
when
</a>
</li>
<li>
<a href='/ruote_website/exp/once.html'>
as_soon_as
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/participant.html'>
participant expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/participant.html'>
participant
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part_implementations.html'>
participant implementations
</a>
</li>
<li>
<a href='/ruote_website/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/ruote_website/process_administration.html'>
process administration
</a>
</li>
<li>
<a href='/ruote_website/definitions.html'>
process definitions
</a>
</li>
<li>
<a href='/ruote_website/process_observation.html'>
process observation
</a>
</li>
<li>
<a href='/ruote_website/participants.html'>
process participants
</a>
</li>
<li>
<a href='/ruote_website/exp/read.html'>
read expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/read.html'>
read
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/redo.html'>
redo expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/redo.html'>
redo
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/ref.html'>
ref expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/ref.html'>
ref
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/registerp.html'>
registerp expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/registerp.html'>
registerp
</a>
</li>
</ul>
<li>
<a href='/ruote_website/rel.html'>
rel values for ruote-http / ruote-kit links
</a>
</li>
<li>
<a href='/ruote_website/exp/reserve.html'>
reserve expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/reserve.html'>
reserve
</a>
</li>
</ul>
<li>
<a href='/ruote_website/resources.html'>
resources
</a>
</li>
<li>
<a href='/ruote_website/exp/restore.html'>
restore expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/restore.html'>
restore
</a>
</li>
<li>
<a href='/ruote_website/exp/restore.html'>
set_fields
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/rev_participant.html'>
rev_participant
</a>
</li>
<li>
<a href='/ruote_website/users.html'>
ruote users
</a>
</li>
<li>
<a href='/ruote_website/sample_workflow_run.html'>
sample workflow run
</a>
</li>
<li>
<a href='/ruote_website/exp/save.html'>
save expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/save.html'>
save
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/sequence.html'>
sequence expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/sequence.html'>
sequence
</a>
</li>
<li>
<a href='/ruote_website/exp/sequence.html'>
let
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/set.html'>
set expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/set.html'>
rset
</a>
</li>
<li>
<a href='/ruote_website/exp/set.html'>
set
</a>
</li>
<li>
<a href='/ruote_website/exp/set.html'>
unset
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/smtp_participant.html'>
smtp_participant
</a>
</li>
<li>
<a href='/ruote_website/source.html'>
source
</a>
</li>
<li>
<a href='/ruote_website/exp/stall.html'>
stall expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/stall.html'>
stall
</a>
</li>
</ul>
<li>
<a href='/ruote_website/part/storage_participant.html'>
storage_participant
</a>
</li>
<li>
<a href='/ruote_website/exp/subprocess.html'>
subprocess expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/subprocess.html'>
subprocess
</a>
</li>
</ul>
<li class='current'>
<a href='/ruote_website/testing_participants.html'>
testing participants
</a>
</li>
<li>
<a href='/ruote_website/testing_processes.html'>
testing processes
</a>
</li>
<li>
<a href='/ruote_website/exp/that.html'>
that expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/that.html'>
that
</a>
</li>
<li>
<a href='/ruote_website/exp/that.html'>
of
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/undo.html'>
undo expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/undo.html'>
undo
</a>
</li>
<li>
<a href='/ruote_website/exp/undo.html'>
cancel
</a>
</li>
<li>
<a href='/ruote_website/exp/undo.html'>
kill
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/unregisterp.html'>
unregisterp expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/unregisterp.html'>
unregisterp
</a>
</li>
</ul>
<li>
<a href='/ruote_website/vars_and_fields.html'>
variables and fields
</a>
</li>
<li>
<a href='/ruote_website/exp/wait.html'>
wait expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/wait.html'>
wait
</a>
</li>
<li>
<a href='/ruote_website/exp/wait.html'>
sleep
</a>
</li>
</ul>
<li>
<a href='/ruote_website/with_rails.html'>
with rails
</a>
</li>
<li>
<a href='/ruote_website/patterns.html'>
workflow control patterns
</a>
</li>
<li>
<a href='/ruote_website/ja.html'>
日本語
</a>
</li>
</ul>
<h3>
More
</h3>
<ul class='contact'>
<li>
<a href='https://github.com/jmettraux/ruote/tree/master/quickstart'>
quickstart
</a>
</li>
<li>
<a href='/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/resources.html'>
resources
</a>
</li>
<li>
<a href='/users.html'>
users
</a>
</li>
</ul>
<h3>
Meta
</h3>
<ul class='contact'>
<li>
<a href='/source.html'>
source
</a>
</li>
<li>
<a href='/download.html'>
download
</a>
</li>
<li>
<a href='http://jmettraux.github.com'>
blog
</a>
</li>
<li>
<a href='/lists.html'>
mailing list
</a>
</li>
<li>
<a href='http://ruote-ci.s3.amazonaws.com/ci.html'>
continuous integration
</a>
</li>
<li>
<a href='http://ruote-irclogs.s3.amazonaws.com/logs.html'>
IRC
</a>
</li>
<li>
<a href='https://www.ohloh.net/p/ruote/'>
on ohloh
</a>
</li>
</ul>
<h3>
<span>
Search
</span>
</h3>
<ul class='contact'>
<li>
<form action='http://www.google.com/search' method='GET'>
<input id='qq' name='qq' style='' type='text'>
<input id='q' name='q' type='hidden'>
<input onclick='adjustSearch();' type='submit' value='search'>
</form>
</li>
</ul>
<script>
  function adjustSearch() {
    $('#q').val($('#qq').val() + ' site:http://ruote.rubyforge.org');
  }
</script>
</div>
<div id='content-main'>
<h2>testing participants</h2>
<p>testing participant implementations.</p>
<p>There are two ways to test participants: <a href="#in_isolation">in isolation</a> and <a href="#in_flow">in flow</a>.</p>
<p>The &#8220;in isolation&#8221; way is to simply setup the participant and exercise it. In the &#8220;in flow&#8221; way, the participant is exercised via a transient (in-memory HashStorage) ruote engine and a minimal flow.</p>
<hr/>
<h3 id="in_isolation">testing in isolation</h3>
<p>This piece of documentation was contributed by <a href="https://github.com/coffeeaddict">Hartog C. de Mik</a></p>
<h4>Introduction</h4>
<p>Testing a participant is gory-detail-stuff. You must know a lot about the internals of Ruote.<br />
Because in order to &#8216;test&#8217; a participant, we have to mimic the environment the participant lives and is executed in.</p>
<h4>Setup</h4>
<p>Since we are isolating the participant in our experiment^W&#8230; tests we have to prevent the participant from communicating with Ruote. In order to do so we have to replace the #reply function with an own singleton.</p>
<pre class="brush: ruby">
participant = Participant.new
def participant.reply; end
</pre>
<p>The singleton-method reply just has to do &#8230; nothing (certainly not reply to the the engine!)</p>
<h4>Create a workitem</h4>
<p>Loading a workitem is pretty simple, just instantiate a Ruote::Workitem and load it with the proper values for your tests.</p>
<h5>Fields</h5>
<pre class="brush: ruby">
wi = Ruote::Workitem.new( 'fields' =&gt; { 'my_field' =&gt; 'my value' } )
</pre>
<h5>Params</h5>
<p>To get the parameters (as given in your process definition), you will have to place them within the #fields hash.</p>
<pre class="brush: ruby">
wi = Ruote::Workitem.new(
  'fields' =&gt; {
    'my_field' =&gt; 'my value'
    'params' =&gt; {
      'passed_from_pdef' =&gt; 'not really, no...'
    },
  })
</pre>
<h4>Injecting a workitem</h4>
<p>Since we want to emulate, or mimic, the environment Ruote builds around our participants, we cannot simply call #on_workitem, we have to do what ruote does.</p>
<pre class="brush: ruby">
it "should receive the workitem" do
  wi = Ruote::Workitem.new( 'fields' =&gt; { 'my_field' =&gt; 'my value' } )
  subject._on_workitem(wi)
  subject.workitem.should == wi
end
</pre>
<p>Or, for old(er) ruote installments</p>
<pre class="brush: ruby">
it "should consume the workitem" do
  wi = Ruote::Workitem.new( 'fields' =&gt; { 'my_field' =&gt; 'my value' } )
  subject.expects(:consume).with(wi)
  subject._consume(wi)
end
</pre>
<h4>Capturing results</h4>
<h5>Workitem updates</h5>
<p>Since you have overridden reply (with nothing) you can just test participant.workitem and expect it to have the latest-greatest.</p>
<h5>Side-effects</h5>
<p>How you test your side-effects is up to you&#8230;</p>
<h4>The StorageParticipant</h4>
<p>If you have subclassed the storage participant, the rules change a little</p>
<h5>Setup</h5>
<p>an order for the storage participant to function properly, an instance of the ruote engine should be supplied</p>
<pre class="brush: ruby">
engine      = Ruote::Dashboard.new(Ruote::HashStorage.new())
participant = MyStorageParticipant(engine)
</pre>
<h5>Load a workitem</h5>
<p>First thing the the StorageParticipant sub-class does (or should do) in #on_workitem is call #super &#8211; this will wreak havoc, unless you make sure that you have a workitem with a (valid) fei</p>
<pre class="brush: ruby">
workitem = RuoteWorkitem.new(
  'fei' =&gt; {
    'expid' =&gt; '0',
    'subid' =&gt; 'abc123',
    'wfid' =&gt; 'some-wfid-could-be-anything',
    'engine_id' =&gt; 'engine' },
  'fields' =&gt; {
    'age_of_the_captain' =&gt; 32 }
)
</pre>
<h4>Disclaimer</h4>
<ul>
	<li>The code examples provided are not runnable out-off-the-box and are meant has a hook for you to start your work on.</li>
	<li>The code examples below are RSpec specific and assume the use of Mocha as a mocking framework.</li>
</ul>
<h3>Code samples</h3>
<p>participant implementation:</p>
<pre class="brush: ruby">
require 'open-uri'

class MyParticipant &lt; Ruote::Participant

  def on_workitem
    begin
      OpenURI.open_uri(workitem.fields['url'])
    rescue SocketError =&gt; error
      workitem.fields['error'] = "#{error.class}: #{error.message}"
    else
      workitem.fields['visited'] = true
    end
  end
end
</pre>
<p>spec/participants/my_participant.rb</p>
<pre class="brush: ruby">

require 'spec_helper'

describe MyParticipant do

  subject { setup_participant MyParticipant }

  it "visits successfully the target URL" do

    subject._on_workitem new_workitem(
      fields: { 'url' =&gt; 'http://ruote.rubyforge.org/' })

    subject.workitem.fields['visited'].should be_true
  end
end
</pre>
<p>spec/support/ruote_helpers.rb</p>
<pre class="brush: ruby">
module RuoteHelpers

  def engine
    @engine ||= RuoteKit.engine # (or some other setup)
  end

  def setup_storage_participant(klass)

    participant = klass.new(engine)

    def participant.update(workitem)
      self.workitem = workitem
    end

    participant
  end

  def setup_participant(klass)

    participant = klass.new()

    def participant.reply
      # catching the reply - it should not do anything
    end

    participant
  end

  def new_workitem(opts)

    opts = Ruote.keys_to_s(opts)

    if opts['params']
      opts['fields']['params'] ||= {}
      opts['fields']['params'].merge!(opts.delete('params'))
    end

    Ruote::Workitem.new(opts.merge(
     'fei' =&gt; {
        'expid'     =&gt; '0',
        'subid'     =&gt; 'abc123',
        'wfid'      =&gt; engine.context.wfidgen.generate,
        'engine_id' =&gt; 'engine',
      }
    ))
  end
end

RSpec.configure do |config|
  config.include RuoteHelpers
end
</pre>
<hr/>
<h3 id="in_flow">testing in flow</h3>
<p><span class="caps">TODO</span></p>
<h3 id="links">links</h3>
<ul>
	<li><a href="http://groups.google.com/group/openwferu-users/browse_thread/thread/707c3ee1ecc14097">some pointers on the mailing list</a></li>
	<li><a href="https://gist.github.com/4546918">original documentation by Hartog de Mik</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id='footer'>
<div id='footer-center'>
<p>
<span id='footer-left'>
<a href='https://github.com/jmettraux/ruote_website/issues'>doc issue reporting</a>
|
<a href='https://github.com/jmettraux/ruote_website'>doc source</a>
| created with
<a href='http://nanoc.stoneship.org'>nanoc</a>
and
<a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
</span>
<span id='footer-right'>
&copy; 2005-2013 the ruote team
</span>
</p>
</div>
</div>
<script>
  SyntaxHighlighter.all();
  
  if (location.hostname != 'localhost' && location.hostname != '127.0.0.1') {
  
    // gauges
  
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '50454d13f5a1f57e4200001b');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  
    // ga
  
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-138748-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
</body>
</html>
 engine.register_participant 'engineering', Acme::EngineerParticipant
</pre>
<p>results in a participant list with 2 participants, &#8216;marketing&#8217; then &#8216;engineering&#8217;.</p>
<p>The :position option may help :</p>
<pre class="brush: ruby">
  engine.register_participant 'alice', Acme::Participant

  engine.register_participant 'bob', Acme::Participant, :position =&gt; 'first'
    # will register bob before alice

  engine.register_participant 'charly', Acme::Participant, :pos =&gt; 1
    # will register charly between bob and alice
</pre>
<p>If you don&#8217;t want to override previous participants with the same regex, you can use the :override =&gt; false option or :position =&gt; &#8216;after&#8217; or &#8216;before&#8217;</p>
<pre class="brush: ruby">
  engine.register_participant 'alice', Acme::ThisParticipant
  engine.register_participant 'alice', Acme::ThatParticipant, :override =&gt; false
    # will result in a participant list with two participants registerd under
    # /^alice$/
</pre>

<pre class="brush: ruby">
  engine.register_participant 'alice', Acme::ThisParticipant
  engine.register_participant 'alice', Acme::ThatParticipant, :pos =&gt; 'before'
    # will register the second /^alice$/ before the first one
    # (the Acme::ThisParticipant one)

  engine.register_participant 'alice', Acme::ThereParticipant, :pos =&gt; 'after'
    # will register the third /^alice$/ after the last one of the alices
    # (in this case Acme::ThisParticipant one)
</pre>
<p>Having multiple registrations for the same regex is useful when using the <a href="implementing_participants.html#accept">#accept?</a> method of participant implementations.</p>
<p>It&#8217;s probably simpler to register all the participants at once with <a href="#r_block" title="&amp;block">engine#register</a> instead of fiddling with engine#register_participant and its options.</p>
<h4 id="r_block">engine#register(&amp;block)</h4>
<p>Thanks to the work of <a href="http://github.com/tosch/">Torsten</a>, it&#8217;s possible to register participants in nice blocks :</p>
<pre class="brush: ruby">
  engine.register do

    notify MyApp::Participants::RemoteNotification, 'flavour' =&gt; 'normal'
    alarm MyApp::Participants::RemoteNotification, 'flavour' =&gt; 'alarm'
      # two participants for notification and alarms

    catchall Ruote::StorageParticipant
      # all the workitems for participants that are neither 'notify' or 'alarm'
      # are caught by a storage participant
  end
</pre>
<p>Note that simply stating &#8220;catchall&#8221; will redirect to a/the storage participant :</p>
<pre class="brush: ruby">
  engine.register do
    catchall
  end
</pre>
<p>is thus equivalent to</p>
<pre class="brush: ruby">
  engine.register do
    catchall Ruote::StorageParticipant
  end
</pre>
<p>The first example above assumes the participant name is the first word encountered (the &#8216;method&#8217; name in fact). If you want to pass a regular expression, use the &#8216;participant&#8217; notation :</p>
<pre class="brush: ruby">
  engine.register do
    participant 'user-.+', Ruote::StorageParticipant
    participant 'action-.+', MyApp::RemoteActionParticipant
  end
</pre>
<p><strong><span class="caps">NOTE</span></strong> : since ruote 2.3.0 register(&amp;block) will clear the participant list by default, thus after</p>
<pre class="brush: ruby">
  engine.register do
    participant 'engineering', Ruote::StorageParticipant
    participant 'marketing', Acme::StorageParticipant
  end
</pre>
<p>one ends up with 2 participants listed, &#8216;engineering&#8217; and &#8216;marketing&#8217;, whatever participants you had previously.</p>
<p>One can prevent this clearing by doing</p>
<pre class="brush: ruby">
  engine.register :clear =&gt; false do
    participant 'engineering', Ruote::StorageParticipant
    participant 'marketing', Acme::StorageParticipant
  end
</pre>
<h4 id="catchall">engine#register(&amp;block) and &#8220;catchall&#8221;</h4>
<p>&#8220;catchall&#8221; when used, is placed last in a registration block:</p>
<pre class="brush: ruby">
  engine.register do
    participant 'user-.+', MyApp::InboxParticipant
    participant 'action-.+', MyApp::RemoteActionParticipant
    catchall
  end
</pre>
<p>This block is equivalent to:</p>
<pre class="brush: ruby">
  engine.register do
    participant 'user-.+', MyApp::InboxParticipant
    participant 'action-.+', MyApp::RemoteActionParticipant
    participant '.+', Ruote::StorageParticipant
  end
</pre>
<p>It catches all the workitems. Placing further participant registrations after a catchall makes thus no sense (they&#8217;ll never be used).</p>
<p>&#8220;catchall&#8221; can be used with participant classes (and options), like in:</p>
<pre class="brush: ruby">
    catchall Acme::DefaultParticipant
</pre>
<p>or:</p>
<pre class="brush: ruby">
    catchall(
      Acme::SmtpParticipant,
      :email =&gt; 'admin@example.com', :msg =&gt; 'unknown participant')
</pre>
<h4 id="r_list">engine#participant_list=</h4>
<p>Starting with ruote 2.1.11, instead of using register_participant and register, you can pass the whole list of participants at once.</p>
<pre class="brush: ruby">
  engine.participant_list = [
    [ /^user-.+$/, 'Ruote::StorageParticipant', {} ],
    [ /^action-.+$/, MyApp::RemoteActionParticipant, { 'server' =&gt; 'main' } ]
  ]
</pre>
<p>Note that it&#8217;s OK to pass the class name as an instance of Class (second line) or as a string (first line).</p>
<p>Checking the current content of the participant list looks like :</p>
<pre class="brush: ruby">
  engine.participant_list.each { |pe| puts pe.to_s }
    #
    # /^user-.+$/ ==&gt; Ruote::StorageParticipant {}
    # /^action-.+$/ ==&gt; MyApp::RemoteActionParticipipant { 'server' =&gt; 'main' }
</pre>
<h3 id="threads">participants and threads</h3>
<p>As you may have gleaned from this doc or from a blog post, ruote 2.1 tries to have only 1 thread per / for the worker, handling all the workflow activity (direct launch/apply orders or triggering schedules). So you end up with 1 extra thread per worker. Note that if you only have an engine (and let the worker run in another runtime, there is no extra thread used by ruote).</p>
<p>(There is an exception with a worker bound to <a href="http://github.com/jmettraux/ruote-couch">ruote-couch</a>, it uses one extra thread to &#8216;observe&#8217; CouchDB (instead of polling it))</p>
<p>Since, most of the time, participant are IO bound, having the dispatching work performed in the worker thread would mean that each delivery to a participant monopolizes the worker. That&#8217;s why, by default, ruote does each participant#consume call in a new thread.</p>
<p>(Maybe we should have a switch to disable participant threading &#8220;en masse&#8221;, it could be OK for small organization deployments, ping me on the <a href="http://groups.google.com/group/openwferu-users">ML</a> or on #ruote if you need this)</p>
<p>A participant instance may inform ruote that it doesn&#8217;t want/need to have its consume method called in a new thread each time. It does that by making sure it has a do_not_thread method and that this method returns true. Since it&#8217;s a method, depending on its implementation, it might not always return true.</p>
<p>As an illustration, the <a href="http://github.com/jmettraux/ruote/blob/ruote2.1/lib/ruote/part/storage_participant.rb">Ruote::StorageParticipant class</a> returns true for do_not_thread (all the time). (trusting you not to have put your storage on Mars while your worker is on Earth).</p>
<p>Some ruote users, have their own implementation of the <a href="http://github.com/jmettraux/ruote/blob/ruote2.1/lib/ruote/svc/dispatch_pool.rb">dispatch pool</a> that enforces an upper threshold for the thread count.</p>
<p>The &#8220;dispatch&#8221; thread is discarded as soon as the delivery to the participant (or the participant consumption and reply) is done.</p>
<h3>see also</h3>
<ul>
	<li><a href="implementing_participants.html">implementing participants</a></li>
	<li>the <a href="exp/participant.html">participant expression</a></li>
	<li><a href="part_implementations.html">participant implementations</a></li>
	<li><a href="participant_testing.html">participant testing</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id='footer'>
<div id='footer-center'>
<p>
<span id='footer-left'>
<a href='https://github.com/jmettraux/ruote_website/issues'>doc issue reporting</a>
|
<a href='https://github.com/jmettraux/ruote_website'>doc source</a>
| created with
<a href='http://nanoc.stoneship.org'>nanoc</a>
and
<a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
</span>
<span id='footer-right'>
&copy; 2005-2013 the ruote team
</span>
</p>
</div>
</div>
<script>
  SyntaxHighlighter.all();
  
  if (location.hostname != 'localhost' && location.hostname != '127.0.0.1') {
  
    // gauges
  
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '50454d13f5a1f57e4200001b');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  
    // ga
  
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-138748-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
</body>
</html>
