<!DOCTYPE html>
<html><head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<title>ruote - implementing a storage</title>
<script src='/ruote_website/js/shCore.js'></script>
<script src='/ruote_website/js/shBrushXml.js'></script>
<script src='/ruote_website/js/shBrushBash.js'></script>
<script src='/ruote_website/js/shBrushRuby.js'></script>
<script src='/ruote_website/js/shBrushJScript.js'></script>
<!-- %script{ :src => "/js/jquery-1.6.1.min.js" } -->
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
<link href='/ruote_website/css/reset.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shCore.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shThemeRuote.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/ruote.css' rel='stylesheet' type='text/css'>
</head><body>
<div id='container'>
<div id='header'>
<div id='header-center'>
<div id='header-left'>
<a href='/ruote_website'>
<img src='/ruote_website/images/ruote.png'>
</a>
<div id='header-subtitle'>
a ruby workflow engine
</div>
</div>
<div id='header-right'>
<div id='nav'>
<span>
<a href='/ruote_website/documentation.html' title='documentation'>
doc
</a>
<a href='/ruote_website/source.html' title='source code'>
source
</a>
<a href='/ruote_website/download.html' title='download'>
download
</a>
<a class='nihongo' href='/ja.html' title='日本語'>
日本語
</a>
</span>
</div>
</div>
</div>
</div>
<div id='content'>
<div id='content-center'>
<div id='sidebar'><h3 onclick='document.location = &quot;/ruote_website/documentation.html&quot;' style='cursor: pointer'>
Documentation
</h3>
<ul>
<li>
<a href='/ruote_website/common_attributes.html'>
common attributes
</a>
</li>
<li>
<a href='/ruote_website/conditions.html'>
conditions
</a>
</li>
<li>
<a href='/ruote_website/configuration.html'>
configuration
</a>
</li>
<li>
<a href='/ruote_website/documentation.html'>
documentation
</a>
</li>
<li>
<a href='/ruote_website/dollar.html'>
dollar notation
</a>
</li>
<li>
<a href='/ruote_website/download.html'>
download
</a>
</li>
<li>
<a href='/ruote_website/expressions.html'>
expressions
</a>
</li>
<li>
<a href='/ruote_website/glossary.html'>
glossary
</a>
</li>
<li class='current'>
<a href='/ruote_website/implementing_a_storage.html'>
implementing a storage
</a>
</li>
<li>
<a href='/ruote_website/implementing_participants.html'>
implementing participants
</a>
</li>
<li>
<a href='/ruote_website/lists.html'>
lists
</a>
</li>
<li>
<a href='/ruote_website/noisy.html'>
noisy output
</a>
</li>
<li>
<a href='/ruote_website/part_implementations.html'>
participant implementations
</a>
</li>
<li>
<a href='/ruote_website/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/ruote_website/process_administration.html'>
process administration
</a>
</li>
<li>
<a href='/ruote_website/definitions.html'>
process definitions
</a>
</li>
<li>
<a href='/ruote_website/process_observation.html'>
process observation
</a>
</li>
<li>
<a href='/ruote_website/participants.html'>
process participants
</a>
</li>
<li>
<a href='/ruote_website/rel.html'>
rel values for ruote-http / ruote-kit links
</a>
</li>
<li>
<a href='/ruote_website/resources.html'>
resources
</a>
</li>
<li>
<a href='/ruote_website/users.html'>
ruote users
</a>
</li>
<li>
<a href='/ruote_website/sample_workflow_run.html'>
sample workflow run
</a>
</li>
<li>
<a href='/ruote_website/source.html'>
source
</a>
</li>
<li>
<a href='/ruote_website/testing_participants.html'>
testing participants
</a>
</li>
<li>
<a href='/ruote_website/testing_processes.html'>
testing processes
</a>
</li>
<li>
<a href='/ruote_website/vars_and_fields.html'>
variables and fields
</a>
</li>
<li>
<a href='/ruote_website/with_rails.html'>
with rails
</a>
</li>
<li>
<a href='/ruote_website/patterns.html'>
workflow control patterns
</a>
</li>
<li>
<a href='/ruote_website/ja.html'>
日本語
</a>
</li>
</ul>
<h3>
More
</h3>
<ul class='contact'>
<li>
<a href='https://github.com/jmettraux/ruote/tree/master/quickstart'>
quickstart
</a>
</li>
<li>
<a href='/ruote_website/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/ruote_website/resources.html'>
resources
</a>
</li>
<li>
<a href='/ruote_website/users.html'>
users
</a>
</li>
</ul>
<h3>
Meta
</h3>
<ul class='contact'>
<li>
<a href='/ruote_website/source.html'>
source
</a>
</li>
<li>
<a href='/ruote_website/download.html'>
download
</a>
</li>
<li>
<a href='http://jmettraux.github.com'>
blog
</a>
</li>
<li>
<a href='/ruote_website/lists.html'>
mailing list
</a>
</li>
<li>
<a href='http://ruote-ci.s3.amazonaws.com/ci.html'>
continuous integration
</a>
</li>
<li>
<a href='http://ruote-irclogs.s3.amazonaws.com/logs.html'>
IRC
</a>
</li>
<li>
<a href='https://www.ohloh.net/p/ruote/'>
on ohloh
</a>
</li>
</ul>
<h3>
<span>
Search
</span>
</h3>
<ul class='contact'>
<li>
<form action='http://www.google.com/search' method='GET'>
<input id='qq' name='qq' style='' type='text'>
<input id='q' name='q' type='hidden'>
<input onclick='adjustSearch();' type='submit' value='search'>
</form>
</li>
</ul>
<script>
  function adjustSearch() {
    $('#q').val($('#qq').val() + ' site:http://ruote.rubyforge.org');
  }
</script>
</div>
<div id='content-main'>
<h2>implementing a storage</h2>
<p>Ruote comes with two storages, an in-memory one and a file system based one. There are <a href="/configuration.html#storage">other storages available</a> each with its advantages and disadvantages.</p>
<p>There is also a composite storage for choosing a different storage depending on the object to store (expression, workitem, error, schedules, &#8230;).</p>
<p>Sometimes one has to implement his own storage, this page ought to help (if it doesn&#8217;t give a shout on the <a href="http://groups.google.com/group/openwferu-users">mailing list</a>).</p>
<p>A storage implementation has to follow a contract : the storage interface.</p>
<h3 id="history">a bit of history</h3>
<p>Storages are at the heart of ruote 2.1.&#215;. Simply look at :</p>
<pre class="brush: ruby">
engine = Ruote::Engine.new(Ruote::Worker.new(ThatStorage.new(info)))
  # or
engine = Ruote::Engine.new(ThatStorage.new(info))
</pre>
<p>Workers and engines need a storage, they communicate via a shared storage.</p>
<p>Ruote has an absolute need for persistence. Processes may outlive the engine runtime. When the engine(s) is/are down, the processes must sleep carefully in the storage, when workers are back, processes <span class="caps">MUST</span> resume.</p>
<p>Ruote 2.1.x push for multiple workers (breaking the 1 Ruby runtime limit) brought a need for preventing workers from overriding / trashing each other&#8217;s work.</p>
<h3 id="documents">documents</h3>
<p>Ruote 2.1.x storage design was strongly influenced by <a href="http://couchdb.apache.org/">CouchDB</a>, especially the concept of documents and their revisions.</p>
<p>Ruote represents all of its data as documents, those documents are <a href="http://json.org"><span class="caps">JSON</span></a> serializable hashes with an &#8220;_id&#8221;, a &#8220;type&#8221; and a &#8220;_rev&#8221;.</p>
<p>The &#8216;type&#8217; is a string like &#8220;expressions&#8221;, &#8220;errors&#8221;, &#8220;workitems&#8221;, &#8220;schedules&#8221;, &#8230;</p>
<p>The &#8216;_id&#8217; attribute is the document identifier.</p>
<h4 id="document_types">document types</h4>
<p>There are 7+1 types of documents:</p>
<table>
	<tr>
		<th>type         </th>
		<th>description</th>
	</tr>
	<tr>
		<td>expressions    </td>
		<td>the atomic pieces of process instance</td>
	</tr>
	<tr>
		<td>msgs           </td>
		<td>&#8216;messages&#8217; to apply/reply to expressions</td>
	</tr>
	<tr>
		<td>schedules      </td>
		<td>msgs scheduled for later processing</td>
	</tr>
	<tr>
		<td>errors         </td>
		<td>errors that occured during process execution (msgs processing)</td>
	</tr>
	<tr>
		<td>variables      </td>
		<td>engine (global) variables</td>
	</tr>
	<tr>
		<td>configurations </td>
		<td>engine configurations</td>
	</tr>
	<tr>
		<td>workitems      </td>
		<td><a href="part/storage_participant.html">StorageParticipant</a> workitems</td>
	</tr>
	<tr>
		<td><em>history</em>      </td>
		<td>(if you use <a href="https://github.com/jmettraux/ruote/blob/master/lib/ruote/log/storage_history.rb">Ruote::StorageHistory</a>)</td>
	</tr>
</table>
<p><span class="caps">TODO</span></p>
<h3 id="consistency">consistency</h3>
<p>Ruote requires some documents to be reserved. If you can not offer exclusive<br />
updates with your storage implementation you are limited to a single<br />
<a href="http://rdoc.info/gems/ruote/Ruote/Worker">worker</a></p>
<p>See the <a href="configuration.html">configuration page</a> for more information on workers in the context of Ruote</p>
<h3 id="interface">interface</h3>
<pre class="brush: ruby">
#--
# core methods
#++

# Store a document
#
# opts:
# ... TODO ...
#
# returns:
# * true if the document has been deleted from the store
# * a document when the rev has changed
# * nil when successfully stored
#
def put(doc, opts={})
end

# get a document by document type and key (_id)
#
def get(type, key)
end

# Delete a document
#
# returns:
# * true if already deleted
# * a document if the rev of the given document is not the rev of the current
#   document
# * nil when successfully removed
#
def delete(doc)
end

# Get many documents of a certain type
#
# input:
# - When key is not specified, return everything from the store
# - Else, do Array(key) and match the collected document id to the given list
#
# opts:
# [:descending]    Return a list, sorted by _id in descending order
# [:count]         Just return a count
# [:skip]          Skip X results
# [:limit]         Limit the list to a length of X
#
# returns:
# * An Integer (when :count was specified)
# * An array of documents
#
def get_many(type, key=nil, opts={})
end

# Return a list of ids for the given document type
#
def ids(type)
end

#--
# auxiliary methods
#++

# Removes all msgs, schedules, errors, expressions and workitems.
#
# It's used mostly when testing workflows, usually when cleaning the
# engine/storage before a workflow run.
#
def clear
end

# Clean the store
#
def purge!
end

# Add a new document type to the store. Some storages might need it.
#
def add_type(type)
end

# Clean the store for the given document type
#
def purge_type!(type)
end
</pre>
<p><span class="caps">TODO</span></p>
<h3 id="models">current implementations as models</h3>
<p>Like for example <a href="http://github.com/jmettraux/ruote/blob/master/lib/ruote/storage/hash_storage.rb">hash_storage.rb</a></p>
<p><span class="caps">TODO</span></p>
<h3 id="testing">testing</h3>
<p>Your storage implementation should survive unit testing and functional testing. If it is meant to be used by multiple workers it should survive concurrence tests as well.</p>
<p>Tests are run from the ruote/ directory. You pass the suffix of the implementation name (like &#8220;redis&#8221; or &#8220;sequel&#8221;) and the test will automatically</p>
<p>For the rest of this section, let&#8217;s assume you&#8217;ve named your storage &#8220;ruote-pasta&#8221; and you&#8217;ve placed it in a ruote-pasta/ dir adjacent to your ruote/ clone.</p>
<p>Your storage implementation must provide a test/functional_connection.rb file containing a &#8220;new_storage&#8221; method. This will indicate to the ruote test suites how to set up your storage for testing. As examples, look at the functional_connection.rb files for <a href="https://github.com/jmettraux/ruote-redis/blob/master/test/functional_connection.rb">ruote-redis</a> and <a href="https://github.com/jmettraux/ruote-sequel/blob/master/test/functional_connection.rb">ruote-sequel</a>.</p>
<h4>unit testing</h4>
<p>Among the ruote unit tests, there is only one that is relevant when testing storages.</p>
<pre class="brush: bash">
$ ruby test/unit/storage.rb -- --pasta
</pre>
<p>Making this test green is your first objective when developing a storage.</p>
<h4>functional testing</h4>
<p>Your storage implementation should survive all the functional tests.</p>
<pre class="brush: bash">
$ ruby test/functional/test.rb -- --pasta
</pre>
<p>If you have difficulties with some dangling test, seek help on the <a href="http://ruote.rubyforge.org/lists.html">mailing list</a>.</p>
<h4>concurrence tests (multiple workers)</h4>
<p>There are currently 3 tests that push ruote storages hard, as if multiple workers were running. They are found under test/functional/ and are prefixed with &#8220;ct_&#8221;.</p>
<p>The technique used to make sure a storage is multi-worker enabled can be described as &#8220;run each of the ct_ tests 200 times and if it never fails, then the storage implementation is OK with multiple workers&#8221;.</p>
<pre class="brush: bash">
$ ./test/looper.sh test/functional/ct_0_concurrence.rb -- --pasta 200
$ ./test/looper.sh test/functional/ct_1_iterator.rb -- --pasta 200
$ ./test/looper.sh test/functional/ct_2_cancel.rb -- --pasta 200
</pre>
<p>Those tests try to force collisions among workers, hopefully witnessing the storage implementation work around the issue gracefully.</p>
</div>
</div>
</div>
</div>
<div id='footer'>
<div id='footer-center'>
<p>
<span id='footer-left'>
<a href='https://github.com/jmettraux/ruote_website/issues'>doc issue reporting</a>
|
<a href='https://github.com/jmettraux/ruote_website'>doc source</a>
| created with
<a href='http://nanoc.stoneship.org'>nanoc</a>
and
<a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
</span>
<span id='footer-right'>
&copy; 2005-2013 the ruote team
</span>
</p>
</div>
</div>
<script>
  SyntaxHighlighter.all();
</script>
</body>
</html>
