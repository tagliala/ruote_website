<!DOCTYPE html>
<html><head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<title>ruote - dollar notation</title>
<script src='/ruote_website/js/shCore.js'></script>
<script src='/ruote_website/js/shBrushXml.js'></script>
<script src='/ruote_website/js/shBrushBash.js'></script>
<script src='/ruote_website/js/shBrushRuby.js'></script>
<script src='/ruote_website/js/shBrushJScript.js'></script>
<!-- %script{ :src => "/js/jquery-1.6.1.min.js" } -->
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
<link href='/ruote_website/css/reset.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shCore.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shThemeRuote.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/ruote.css' rel='stylesheet' type='text/css'>
</head><body>
<div id='container'>
<div id='header'>
<div id='header-center'>
<div id='header-left'>
<a href='/ruote_website'>
<img src='/ruote_website/images/ruote.png'>
</a>
<div id='header-subtitle'>
a ruby workflow engine
</div>
</div>
<div id='header-right'>
<div id='nav'>
<span>
<a href='/ruote_website/documentation.html' title='documentation'>
doc
</a>
<a href='/ruote_website/source.html' title='source code'>
source
</a>
<a href='/ruote_website/download.html' title='download'>
download
</a>
<a class='nihongo' href='/ja.html' title='日本語'>
日本語
</a>
</span>
</div>
</div>
</div>
</div>
<div id='content'>
<div id='content-center'>
<div id='sidebar'><h3 onclick='document.location = &quot;/ruote_website/documentation.html&quot;' style='cursor: pointer'>
Documentation
</h3>
<ul>
<li>
<a href='/ruote_website//exp/add_branches.html'>
add_branches expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/add_branches.html'>
add_branches
</a>
</li>
<li>
<a href='/ruote_website//exp/add_branches.html'>
add_branch
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/apply.html'>
apply expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/apply.html'>
apply
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/await.html'>
await expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/await.html'>
await
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/block_participant.html'>
block_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/cancel_process.html'>
cancel_process expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/cancel_process.html'>
cancel_process
</a>
</li>
<li>
<a href='/ruote_website//exp/cancel_process.html'>
terminate
</a>
</li>
<li>
<a href='/ruote_website//exp/cancel_process.html'>
kill_process
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/code_participant.html'>
code_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
command expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/command.html'>
skip
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
back
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
jump
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
rewind
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
continue
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
break
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
stop
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
over
</a>
</li>
<li>
<a href='/ruote_website//exp/command.html'>
reset
</a>
</li>
</ul>
<li>
<a href='/ruote_website//common_attributes.html'>
common attributes
</a>
</li>
<li>
<a href='/ruote_website//exp/concurrence.html'>
concurrence expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/concurrence.html'>
concurrence
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/concurrent_iterator.html'>
concurrent_iterator expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/concurrent_iterator.html'>
concurrent_iterator
</a>
</li>
<li>
<a href='/ruote_website//exp/concurrent_iterator.html'>
citerator
</a>
</li>
</ul>
<li>
<a href='/ruote_website//conditions.html'>
conditions
</a>
</li>
<li>
<a href='/ruote_website//configuration.html'>
configuration
</a>
</li>
<li>
<a href='/ruote_website//exp/cron.html'>
cron expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/cron.html'>
cron
</a>
</li>
<li>
<a href='/ruote_website//exp/cron.html'>
every
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/cursor.html'>
cursor expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/cursor.html'>
cursor
</a>
</li>
<li>
<a href='/ruote_website//exp/cursor.html'>
loop
</a>
</li>
<li>
<a href='/ruote_website//exp/cursor.html'>
repeat
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/decision_participant.html'>
decision_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/define.html'>
define expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/define.html'>
define
</a>
</li>
<li>
<a href='/ruote_website//exp/define.html'>
process_definition
</a>
</li>
<li>
<a href='/ruote_website//exp/define.html'>
workflow_definition
</a>
</li>
</ul>
<li>
<a href='/ruote_website//documentation.html'>
documentation
</a>
</li>
<li class='current'>
<a href='/ruote_website//dollar.html'>
dollar notation
</a>
</li>
<li>
<a href='/ruote_website//download.html'>
download
</a>
</li>
<li>
<a href='/ruote_website//exp/echo.html'>
echo expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/echo.html'>
echo
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/engine_participant.html'>
engine_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/equals.html'>
equals expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/equals.html'>
equals
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/error.html'>
error expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/error.html'>
error
</a>
</li>
</ul>
<li>
<a href='/ruote_website//expressions.html'>
expressions
</a>
</li>
<li>
<a href='/ruote_website//exp/filter.html'>
filter expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/filter.html'>
filter
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/forget.html'>
forget expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/forget.html'>
forget
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/given.html'>
given expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/given.html'>
given
</a>
</li>
</ul>
<li>
<a href='/ruote_website//glossary.html'>
glossary
</a>
</li>
<li>
<a href='/ruote_website//exp/if.html'>
if expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/if.html'>
if
</a>
</li>
</ul>
<li>
<a href='/ruote_website//implementing_a_storage.html'>
implementing a storage
</a>
</li>
<li>
<a href='/ruote_website//implementing_participants.html'>
implementing participants
</a>
</li>
<li>
<a href='/ruote_website//exp/inc.html'>
inc expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/inc.html'>
inc
</a>
</li>
<li>
<a href='/ruote_website//exp/inc.html'>
dec
</a>
</li>
<li>
<a href='/ruote_website//exp/inc.html'>
increment
</a>
</li>
<li>
<a href='/ruote_website//exp/inc.html'>
decrement
</a>
</li>
<li>
<a href='/ruote_website//exp/inc.html'>
push
</a>
</li>
<li>
<a href='/ruote_website//exp/inc.html'>
pop
</a>
</li>
</ul>
<li>
<a href='/ruote_website//'>
index
</a>
</li>
<li>
<a href='/ruote_website//exp/iterator.html'>
iterator expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/iterator.html'>
iterator
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/let.html'>
let expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/let.html'>
let
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/listen.html'>
listen expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/listen.html'>
listen
</a>
</li>
<li>
<a href='/ruote_website//exp/listen.html'>
receive
</a>
</li>
<li>
<a href='/ruote_website//exp/listen.html'>
intercept
</a>
</li>
</ul>
<li>
<a href='/ruote_website//lists.html'>
lists
</a>
</li>
<li>
<a href='/ruote_website//part/local_participant.html'>
local_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/lose.html'>
lose expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/lose.html'>
lose
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/no_op_participant.html'>
no_op_participant
</a>
</li>
<li>
<a href='/ruote_website//noisy.html'>
noisy output
</a>
</li>
<li>
<a href='/ruote_website//exp/noop.html'>
noop expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/noop.html'>
noop
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/null_participant.html'>
null_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/on_error.html'>
on_error expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/on_error.html'>
on_error
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/once.html'>
once expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/once.html'>
once
</a>
</li>
<li>
<a href='/ruote_website//exp/once.html'>
when
</a>
</li>
<li>
<a href='/ruote_website//exp/once.html'>
as_soon_as
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/participant.html'>
participant expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/participant.html'>
participant
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part_implementations.html'>
participant implementations
</a>
</li>
<li>
<a href='/ruote_website//presentations.html'>
presentations
</a>
</li>
<li>
<a href='/ruote_website//process_administration.html'>
process administration
</a>
</li>
<li>
<a href='/ruote_website//definitions.html'>
process definitions
</a>
</li>
<li>
<a href='/ruote_website//process_observation.html'>
process observation
</a>
</li>
<li>
<a href='/ruote_website//participants.html'>
process participants
</a>
</li>
<li>
<a href='/ruote_website//exp/read.html'>
read expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/read.html'>
read
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/redo.html'>
redo expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/redo.html'>
redo
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/ref.html'>
ref expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/ref.html'>
ref
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/registerp.html'>
registerp expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/registerp.html'>
registerp
</a>
</li>
</ul>
<li>
<a href='/ruote_website//rel.html'>
rel values for ruote-http / ruote-kit links
</a>
</li>
<li>
<a href='/ruote_website//exp/reserve.html'>
reserve expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/reserve.html'>
reserve
</a>
</li>
</ul>
<li>
<a href='/ruote_website//resources.html'>
resources
</a>
</li>
<li>
<a href='/ruote_website//exp/restore.html'>
restore expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/restore.html'>
restore
</a>
</li>
<li>
<a href='/ruote_website//exp/restore.html'>
set_fields
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/rev_participant.html'>
rev_participant
</a>
</li>
<li>
<a href='/ruote_website//users.html'>
ruote users
</a>
</li>
<li>
<a href='/ruote_website//sample_workflow_run.html'>
sample workflow run
</a>
</li>
<li>
<a href='/ruote_website//exp/save.html'>
save expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/save.html'>
save
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/sequence.html'>
sequence expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/sequence.html'>
sequence
</a>
</li>
<li>
<a href='/ruote_website//exp/sequence.html'>
let
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/set.html'>
set expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/set.html'>
rset
</a>
</li>
<li>
<a href='/ruote_website//exp/set.html'>
set
</a>
</li>
<li>
<a href='/ruote_website//exp/set.html'>
unset
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/smtp_participant.html'>
smtp_participant
</a>
</li>
<li>
<a href='/ruote_website//source.html'>
source
</a>
</li>
<li>
<a href='/ruote_website//exp/stall.html'>
stall expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/stall.html'>
stall
</a>
</li>
</ul>
<li>
<a href='/ruote_website//part/storage_participant.html'>
storage_participant
</a>
</li>
<li>
<a href='/ruote_website//exp/subprocess.html'>
subprocess expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/subprocess.html'>
subprocess
</a>
</li>
</ul>
<li>
<a href='/ruote_website//testing_participants.html'>
testing participants
</a>
</li>
<li>
<a href='/ruote_website//testing_processes.html'>
testing processes
</a>
</li>
<li>
<a href='/ruote_website//exp/that.html'>
that expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/that.html'>
that
</a>
</li>
<li>
<a href='/ruote_website//exp/that.html'>
of
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/undo.html'>
undo expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/undo.html'>
undo
</a>
</li>
<li>
<a href='/ruote_website//exp/undo.html'>
cancel
</a>
</li>
<li>
<a href='/ruote_website//exp/undo.html'>
kill
</a>
</li>
</ul>
<li>
<a href='/ruote_website//exp/unregisterp.html'>
unregisterp expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/unregisterp.html'>
unregisterp
</a>
</li>
</ul>
<li>
<a href='/ruote_website//vars_and_fields.html'>
variables and fields
</a>
</li>
<li>
<a href='/ruote_website//exp/wait.html'>
wait expression
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website//exp/wait.html'>
wait
</a>
</li>
<li>
<a href='/ruote_website//exp/wait.html'>
sleep
</a>
</li>
</ul>
<li>
<a href='/ruote_website//with_rails.html'>
with rails
</a>
</li>
<li>
<a href='/ruote_website//patterns.html'>
workflow control patterns
</a>
</li>
<li>
<a href='/ruote_website//ja.html'>
日本語
</a>
</li>
</ul>
<h3>
More
</h3>
<ul class='contact'>
<li>
<a href='https://github.com/jmettraux/ruote/tree/master/quickstart'>
quickstart
</a>
</li>
<li>
<a href='/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/resources.html'>
resources
</a>
</li>
<li>
<a href='/users.html'>
users
</a>
</li>
</ul>
<h3>
Meta
</h3>
<ul class='contact'>
<li>
<a href='/source.html'>
source
</a>
</li>
<li>
<a href='/download.html'>
download
</a>
</li>
<li>
<a href='http://jmettraux.github.com'>
blog
</a>
</li>
<li>
<a href='/lists.html'>
mailing list
</a>
</li>
<li>
<a href='http://ruote-ci.s3.amazonaws.com/ci.html'>
continuous integration
</a>
</li>
<li>
<a href='http://ruote-irclogs.s3.amazonaws.com/logs.html'>
IRC
</a>
</li>
<li>
<a href='https://www.ohloh.net/p/ruote/'>
on ohloh
</a>
</li>
</ul>
<h3>
<span>
Search
</span>
</h3>
<ul class='contact'>
<li>
<form action='http://www.google.com/search' method='GET'>
<input id='qq' name='qq' style='' type='text'>
<input id='q' name='q' type='hidden'>
<input onclick='adjustSearch();' type='submit' value='search'>
</form>
</li>
</ul>
<script>
  function adjustSearch() {
    $('#q').val($('#qq').val() + ' site:http://ruote.rubyforge.org');
  }
</script>
</div>
<div id='content-main'>
<h2>dollar notation</h2>
<p>(for documentation about conditions and the dollar notation, see <a href="conditions.html">conditions</a>)</p>
<p>Most of the examples feature plainly named participant like</p>
<pre class="brush: ruby">
  sequence do
    participant 'alfred'
    participant 'bob'
  end
</pre>
<p>but the real world is more dynamic:</p>
<pre class="brush: ruby">
  sequence do
    participant '${f:patient}'
    participant '${f:doctor}'
  end
</pre>
<p>In that mini process definition, the workitem is routed from the patient to the doctor. The actual participant name is held in the workitem field &#8220;patient&#8221; and then in the field named &#8220;doctor&#8221;. Since it&#8217;s a sequence, the value in the field doctor could have been set by the patient.</p>
<p>The prefix <code>f</code> comes for <code>field</code>, as in workitem field.</p>
<p>This &#8220;dollar notation&#8221; scans strings in process definition for <code>${...}</code> constructs and substitutes them for their workitem field or process variable value.</p>
<p>If <a href="#ruby_eval_allowed"><code>ruby_eval_allowed</code></a> is set to true, <code>${r:code}</code> will evaluate (after a security check) the code and place the result in the target string.</p>
<p>Not all dollar substitutions result in a string, there is a technique for pointing a field or variable values <a href="#literally">literally</a>.</p>
<h3>variables and workitem fields</h3>
<p>(the main piece of documentation about this subject is at <a href="vars_and_fields.html">process variables and workitem fields</a>)</p>
<p>Two types of data are available to process instances: process variables and workitem fields.</p>
<p>The most visible type is workitem fields. Each workitem has a dictionary of fields as payload. Workitem and their fields are visible to the participants (ie outside of the workflow engine itself).</p>
<p>Process variables are not communicated outside of the engine (except if the <a href="exp/set.html"><code>set</code></a> expression is used to copy a variable to a field). Variables are mainly used for routing decisions inside the process instance.</p>
<pre class="brush: ruby">
Ruote.process_definition :name =&gt; 'loan_approval', :revision =&gt; '1' do
  cursor do
    participant 'planning team'
    concurrence do
      participant 'ceo', :if =&gt; '${f:total} &gt; 100000'
      participant 'cfo'
    end
    rewind :unless =&gt; '${f:approved}'
    participant 'execution team'
  end
end
</pre>
<p>In this first example process definition, there are two fields visible from the process definition: &#8216;total&#8217; and &#8216;approved&#8217;. The total has been determined by the planning team, while the &#8216;approved&#8217; field will be set by the cfo (and perhaps the ceo).</p>
<p>Note that if the total is superior to 100&#8217;000, the ceo, concurrently with the cfo, will receive a workitem. Thus the workitem (and its fields) will get duplicated, one copy for each concurrence branch. Process variables never get &#8220;cloned&#8221; in this way.</p>
<pre class="brush: ruby">
Ruote.process_definition :name =&gt; 'loan_approval', :revision =&gt; '2' do
  cursor do
    participant 'planning team'
    concurrence do
      participant 'ceo', :if =&gt; '${v:supervised}'
      participant 'cfo'
    end
    rewind :unless =&gt; '${f:approved}'
    participant 'execution team'
  end
end
</pre>
<p>In that example, if the process variable &#8220;supervised&#8221; is set to <code>true</code>, the ceo will have his say in the iterations. The information about whether or not the process instance is supervised is not passed to participants (well obviously the ceo will know).</p>
<h3 id="default">by default ${key} points to the field &#8216;key&#8217;</h3>
<p>Since ruote 2.1, the following two process definitions are equivalent:</p>
<pre class="brush: ruby">
  sequence do
    participant '${f:patient}'
    participant '${field:doctor}'
  end
</pre>

<pre class="brush: ruby">
  sequence do
    participant '${patient}'
    participant '${doctor}'
  end
</pre>
<h3 id="deep">deep lookup (composite keys)</h3>
<p>Imagine you have this process definition:</p>
<pre class="brush: ruby">
Ruote.process_definition :name =&gt; 'contract preparation' do
  sequence do

    set 'field:customer' =&gt; {
      'name' =&gt; 'Dexter Shipping',
      'address' =&gt; [ 'Orchard Road', 'Singapore' ]
    }
      # setting some field f one way or the other

    # ...
    participant 'legal dept', :task =&gt; 'draft contract for ${f:customer.name}'
    # ...
    participant 'asia rep', :if =&gt; "${f:customer.address.1}' == 'Singapore'"
    # ...
  end
end
</pre>
<p>It&#8217;s OK to use dots and key names or integer indexes to look deep inside of a field or a variable (<code>${v:partner.address.city}</code>).</p>
<h3 id="initial">initial fields and initial variables</h3>
<p>Looking at the <a href="#deep">above example</a>, one thing should be clear: our customer information is hardcoded in the business process.</p>
<p>Why not remove it?</p>
<pre class="brush: ruby">
pdef = Ruote.process_definition :name =&gt; 'contract preparation' do
  sequence do
    participant 'legal dept', :task =&gt; 'draft contract for ${f:customer.name}'
    # ...
    participant 'asia rep', :if =&gt; "${f:customer.address.1}' == 'Singapore'"
    # ...
  end
end
</pre>
<p>and pass the information in due time, i.e. at launch time?</p>
<pre class="brush: ruby">
ruote_engine.launch(
  pdef,
  { 'customer' =&gt; {
    'name' =&gt; 'Dexter Shipping',
    'address' =&gt; [ 'Orchard Road', 'Singapore' ] } })
</pre>
<p>The signature for the launch method looks like</p>
<pre class="brush: ruby">
def launch(process_definition, fields={}, variables={})
</pre>
<p>Fields are the initial fields (payload) of the workitem and variables are the initial variables at the root of the process instance getting launched.</p>
<h3 id="nesting">mixing and nesting</h3>
<p>Mixing and nesting is OK.</p>
<pre class="brush: ruby">
Ruote.process_definition do
  # ...
  set 'f:a' =&gt; 'al'
  set 'f:b' =&gt; 'fred'
  set 'f:alfred' =&gt; 'albert'
  # ...
  participant '${a}'         # participant 'al'
  participant '${b}'         # participant 'fred'
  participant '${a}${b}'     # participant 'alfred'
  participant '${al${b}}'    # participant 'albert'
  participant '${${a}${b}}'  # participant 'albert'
end
</pre>
<h3 id="wfid"><code>${fei}</code>, <code>${wfid}</code>, <code>${subid}</code>, <code>${expid}</code>, and <code>${engine_id}</code></h3>
<p>This tiny program:</p>
<pre class="brush: ruby">
require 'rubygems'
require 'ruote'

engine = Ruote::Engine.new(Ruote::Worker.new(Ruote::HashStorage.new()))

engine.register_participant :wrongdoer do |workitem|
  raise "I did something wrong"
end

pdef = Ruote.process_definition do
  sequence do
    echo 'fei       : ${fei}'
    echo 'wfid      : ${wfid}'
    echo 'expid     : ${expid}'
    echo 'subid     : ${subid}'
    echo 'engine_id : ${engine_id}'
  end
end

wfid = engine.launch(pdef)

engine.wait_for(wfid)
</pre>
<p>will emit to the standard output something like:</p>
<pre class="brush: jscript">
fei       : 0_0_0!!20100407-bipopopizu
wfid      : 20100407-bipopopizu
expid     : 0_0_2
subid     : 2cf8837dec6eda1f5da484a2a5bb4bc5
engine_id : engine
</pre>
<p>These are not the content of the fields <code>fei</code>, <code>wfid</code>, <code>expid</code>, <code>subid</code>. It&#8217;s the flow expression id, the workflow instance id, the expression id and the sub workflow instance id.</p>
<p>The <code>fei</code> is a compound of the three others.</p>
<p>This technique can be used in various ways. Here is an example:</p>
<pre class="brush: ruby">
Ruote.process_definition :name =&gt; 'new batch' do
  sequence do
    set 'batch_id' =&gt; 'batch--${wfid}'
    clerks :task =&gt; 'input new batch'
    testers :task =&gt; 'schedule tests for new batch'
  end
end
</pre>
<p>The field <code>batch_id</code> is set to something like <code>batch--20100407-barakuraba</code>.</p>
<h3 id="literally"><code>$x</code>, <code>$f:x</code>, <code>$v:y</code></h3>
<p>All the dollar examples so far result in strings being composed. What if you want the want the literal workitem field or process variable blue to be given ?</p>
<pre class="brush: ruby">
Ruote.process_definition do
  set 'v:customers' = [ 'Steiner', 'Stransky', 'Brandt' ]
  set 'v:order_id' = 12345
  # ...
  participant 'salesman', :customers =&gt; '$v:customers', :order =&gt; '$v:order_id'
end
</pre>
<p>Note the lack of curly brackets (and the single reference). This literal technique only works with when the final substitution is of the form &#8220;^\$[^{}:]+$&#8221;.</p>
<p>No substitution will occur:</p>
<pre class="brush: ruby">
Ruote.process_definition do
  echo ' $x '    # =&gt; ' $x '
  echo ' $v:x '  # =&gt; ' $v:x '
  echo ' $v:x'   # =&gt; ' $v:x'
  # ...
end
</pre>
<p>Nesting and mixing is OK as well, as long as the final substitution lacks the curly brackets :</p>
<pre class="brush: ruby">
Ruote.process_definition do
  # ...
  set 'v:a' =&gt; 'al'
  set 'v:b' =&gt; 'fred'
  set 'v:alfred' =&gt; { 'name' =&gt; 'Alfred', 'age' =&gt; 23 }
  # ...
  subprocess 'x', :customer =&gt; '$v:${a}${b}'
    # customer will hold the 'alfred' hash
end
</pre>
<h3 id="missing_value">dollar notation and missing values</h3>
<p>A vanilla expression like &#8220;${f:x}&#8221; will yield &#8220;${f:x}&#8221; when there is no workitem field named &#8220;x&#8221; (missing value). The same holds for &#8220;$x&#8221;, it&#8217;d yield &#8220;$x&#8221;&#8230; Up until ruote 2.3.0 included. From ruote 2.3.1 on, &#8220;$x&#8221; will yield nil (we expect a value, not a string value as in the &#8220;${f:x}&#8221; case.</p>
<h3 id="quotes">${&#8217;f:x} and ${&quot;f:x} quoting</h3>
<p>The dollar notation has a special little trick. If you place a &#8217; or a &quot; right after the opening {, the resulting string will get double-quoted.</p>
<pre class="brush: ruby">
emit_invoice :if =&gt; '${"name} == "joe smunch"'
</pre>
<p>if the workitem field named &#8216;name&#8217; holds &#8220;jeff bunch&#8221;, the comparison will look like</p>
<pre class="brush: ruby">
'"jeff bunch" == "joe smuch"'
</pre>
<p>(and yield <em>false</em>).</p>
<h3 id="ruby_eval_allowed"><code>ruby_eval_allowed</code></h3>
<p>When the engine is <a href="configuration.html#engine">configured</a> with &#8216;ruby_eval_allowed&#8217; =&gt; true, which boils down to</p>
<pre class="brush: ruby">
engine = Ruote::Engine.new(
  Ruote::Worker.new(
    Ruote::HashStorage.new('ruby_eval_allowed' =&gt; true)))
</pre>
<p>a special (and dangerous) <code>r</code> or <code>ruby</code> prefix gets unlocked.</p>
<pre class="brush: ruby">
Ruote.process_definition :name =&gt; 'new batch' do
  sequence do
    set 'batch_id' =&gt; '${r:Operations.generate_batch_id}'
    clerks :task =&gt; 'input new batch'
    testers :task =&gt; 'schedule tests for new batch'
    clerks :task =&gt; 'schedule transport',
      :if =&gt; '${r:Operations.no_transport_available?}'
  end
end
</pre>
<p>This process definition calls to methods from the Operations module, one to generate a batch id and the second to check if transports are available.</p>
<p>Ruote tries is best to prevent dangerous operations from happening whithin the <code>${r:xxx}</code> envelope, but beware! Especially if your process definitions are loaded from untrusted sources.</p>
<p>The Ruby code within <code>${r:xxx}</code> has access to</p>
<ul>
	<li><strong>flow_expression, fe, fexp</strong>: the FlowExpression itself</li>
	<li><strong>fei</strong>: the id of the FlowExpression</li>
	<li><strong>workitem, wi</strong>: the workitem</li>
	<li><strong>engine_id</strong>: the id of the engine</li>
	<li><strong>d()</strong>: a way to bring back regular dollar substitution inside of ${r:&#8230;}</li>
	<li><strong>&#8220;method_missing&#8221;</strong>: a shortcut to workitem fields</li>
</ul>
<p>Here is a potpourri of those:</p>
<pre class="brush: ruby">
require 'rubygems'
require 'ruote'

engine = Ruote::Engine.new(
  Ruote::Worker.new(
    Ruote::HashStorage.new('ruby_eval_allowed' =&gt; true)))

#engine.noisy = true

pdef = Ruote.define do

  set 'v:var0' =&gt; 'hello'

  echo '${r:fei.sid}'
    # =&gt; 0_1!51ea612b76a8b2670050abf4583b9406!20110218-besushipoki
  echo '${r:wi.fields.size}'
    # =&gt; 1
  echo '${r:fexp.name}'
    # =&gt; echo
  echo "${r:d('customer.address.0').downcase}"
    # =&gt; sycamore street 1
  echo "${r:d('v:var0')}"
    # =&gt; hello
  echo "${r:customer['name']}"
    # =&gt; Alain
end

wfid = engine.launch(
  pdef,
  'customer' =&gt; {
    'name' =&gt; 'Alain',
    'address' =&gt; [ 'Sycamore Street 1', 'Triple Peaks' ]
  })

engine.wait_for(wfid)
</pre>
<h3>see also</h3>
<ul>
	<li><a href="conditions.html">conditions</a></li>
	<li><a href="vars_and_fields.html">process variables and workitem fields</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id='footer'>
<div id='footer-center'>
<p>
<span id='footer-left'>
<a href='https://github.com/jmettraux/ruote_website/issues'>doc issue reporting</a>
|
<a href='https://github.com/jmettraux/ruote_website'>doc source</a>
| created with
<a href='http://nanoc.stoneship.org'>nanoc</a>
and
<a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
</span>
<span id='footer-right'>
&copy; 2005-2013 the ruote team
</span>
</p>
</div>
</div>
<script>
  SyntaxHighlighter.all();
</script>
</body>
</html>
