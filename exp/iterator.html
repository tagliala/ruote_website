<!DOCTYPE html>
<html><head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<title>ruote - iterator expression</title>
<script src='/ruote_website/js/shCore.js'></script>
<script src='/ruote_website/js/shBrushXml.js'></script>
<script src='/ruote_website/js/shBrushBash.js'></script>
<script src='/ruote_website/js/shBrushRuby.js'></script>
<script src='/ruote_website/js/shBrushJScript.js'></script>
<!-- %script{ :src => "/js/jquery-1.6.1.min.js" } -->
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
<link href='/ruote_website/css/reset.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shCore.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shThemeRuote.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/ruote.css' rel='stylesheet' type='text/css'>
</head><body>
<div id='container'>
<div id='header'>
<div id='header-center'>
<div id='header-left'>
<a href='/ruote_website'>
<img src='/ruote_website/images/ruote.png'>
</a>
<div id='header-subtitle'>
a ruby workflow engine
</div>
</div>
<div id='header-right'>
<div id='nav'>
<span>
<a href='/ruote_website/documentation.html' title='documentation'>
doc
</a>
<a href='/ruote_website/source.html' title='source code'>
source
</a>
<a href='/ruote_website/download.html' title='download'>
download
</a>
<a class='nihongo' href='/ja.html' title='日本語'>
日本語
</a>
</span>
</div>
</div>
</div>
</div>
<div id='content'>
<div id='content-center'>
<div id='sidebar'><h3 onclick='document.location = &quot;/ruote_website/documentation.html&quot;' style='cursor: pointer'>
Documentation
</h3>
<ul>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branches
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branch
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/apply.html'>
apply
</a>
</li>
<li>
<a href='/ruote_website/exp/await.html'>
await
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
cancel_process
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
terminate
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
kill_process
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/command.html'>
command
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/command.html'>
skip
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
back
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
jump
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
rewind
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
continue
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
break
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
stop
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
over
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
reset
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/concurrence.html'>
concurrence
</a>
</li>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
concurrent_iterator
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
citerator
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/cron.html'>
cron
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cron.html'>
every
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/cursor.html'>
cursor
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cursor.html'>
loop
</a>
</li>
<li>
<a href='/ruote_website/exp/cursor.html'>
repeat
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/define.html'>
define
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/define.html'>
process_definition
</a>
</li>
<li>
<a href='/ruote_website/exp/define.html'>
workflow_definition
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/echo.html'>
echo
</a>
</li>
<li>
<a href='/ruote_website/exp/equals.html'>
equals
</a>
</li>
<li>
<a href='/ruote_website/exp/error.html'>
error
</a>
</li>
<li>
<a href='/ruote_website/exp/filter.html'>
filter
</a>
</li>
<li>
<a href='/ruote_website/exp/forget.html'>
forget
</a>
</li>
<li>
<a href='/ruote_website/exp/given.html'>
given
</a>
</li>
<li>
<a href='/ruote_website/exp/if.html'>
if
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
inc
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/inc.html'>
dec
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
increment
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
decrement
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
push
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
pop
</a>
</li>
</ul>
<li class='current'>
<a href='/ruote_website/exp/iterator.html'>
iterator
</a>
</li>
<li>
<a href='/ruote_website/exp/let.html'>
let
</a>
</li>
<li>
<a href='/ruote_website/exp/listen.html'>
listen
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/listen.html'>
receive
</a>
</li>
<li>
<a href='/ruote_website/exp/listen.html'>
intercept
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/lose.html'>
lose
</a>
</li>
<li>
<a href='/ruote_website/exp/noop.html'>
noop
</a>
</li>
<li>
<a href='/ruote_website/exp/on_error.html'>
on_error
</a>
</li>
<li>
<a href='/ruote_website/exp/once.html'>
once
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/once.html'>
when
</a>
</li>
<li>
<a href='/ruote_website/exp/once.html'>
as_soon_as
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/participant.html'>
participant
</a>
</li>
<li>
<a href='/ruote_website/exp/read.html'>
read
</a>
</li>
<li>
<a href='/ruote_website/exp/redo.html'>
redo
</a>
</li>
<li>
<a href='/ruote_website/exp/ref.html'>
ref
</a>
</li>
<li>
<a href='/ruote_website/exp/registerp.html'>
registerp
</a>
</li>
<li>
<a href='/ruote_website/exp/reserve.html'>
reserve
</a>
</li>
<li>
<a href='/ruote_website/exp/restore.html'>
restore
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/restore.html'>
set_fields
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/save.html'>
save
</a>
</li>
<li>
<a href='/ruote_website/exp/sequence.html'>
sequence
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/sequence.html'>
let
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/set.html'>
set
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/set.html'>
rset
</a>
</li>
<li>
<a href='/ruote_website/exp/set.html'>
unset
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/stall.html'>
stall
</a>
</li>
<li>
<a href='/ruote_website/exp/subprocess.html'>
subprocess
</a>
</li>
<li>
<a href='/ruote_website/exp/that.html'>
that
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/that.html'>
of
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/undo.html'>
undo
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/undo.html'>
cancel
</a>
</li>
<li>
<a href='/ruote_website/exp/undo.html'>
kill
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/unregisterp.html'>
unregisterp
</a>
</li>
<li>
<a href='/ruote_website/exp/wait.html'>
wait
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/wait.html'>
sleep
</a>
</li>
</ul>
</ul>
<h3>
More
</h3>
<ul class='contact'>
<li>
<a href='https://github.com/jmettraux/ruote/tree/master/quickstart'>
quickstart
</a>
</li>
<li>
<a href='/ruote_website/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/ruote_website/resources.html'>
resources
</a>
</li>
<li>
<a href='/ruote_website/users.html'>
users
</a>
</li>
</ul>
<h3>
Meta
</h3>
<ul class='contact'>
<li>
<a href='/ruote_website/source.html'>
source
</a>
</li>
<li>
<a href='/ruote_website/download.html'>
download
</a>
</li>
<li>
<a href='http://jmettraux.github.com'>
blog
</a>
</li>
<li>
<a href='/ruote_website/lists.html'>
mailing list
</a>
</li>
<li>
<a href='http://ruote-ci.s3.amazonaws.com/ci.html'>
continuous integration
</a>
</li>
<li>
<a href='http://ruote-irclogs.s3.amazonaws.com/logs.html'>
IRC
</a>
</li>
<li>
<a href='https://www.ohloh.net/p/ruote/'>
on ohloh
</a>
</li>
</ul>
<h3>
<span>
Search
</span>
</h3>
<ul class='contact'>
<li>
<form action='http://www.google.com/search' method='GET'>
<input id='qq' name='qq' style='' type='text'>
<input id='q' name='q' type='hidden'>
<input onclick='adjustSearch();' type='submit' value='search'>
</form>
</li>
</ul>
<script>
  function adjustSearch() {
    $('#q').val($('#qq').val() + ' site:http://ruote.rubyforge.org');
  }
</script>
</div>
<div id='content-main'>
<h2>iterator</h2>
<p>Iterating on a list of values</p>
<pre class="brush: ruby">
  pdef = Ruote.process_definition :name =&gt; 'test' do
    iterator :on_val =&gt; 'alice, bob, charly', :to_var =&gt; 'v' do
      participant '${v:v}'
    end
  end
</pre>
<p>This expression expects at list an &#8216;on&#8217; attribute, which can be :on,<br />
:on_val, :on_value for a value (usually a comma separated list), :on_v,<br />
:on_var, :on_variable for a list contained in the designated variable and<br />
:on_f, :on_fld, :on_field for a list contained in the designated workitem<br />
field.</p>
<p>The &#8216;on&#8217; attribute is used to instruct the expression on which list/array<br />
it should iterate.</p>
<p>The &#8216;to&#8217; attribute takes two forms, :to_v, :to_var, :to_variable or<br />
:to_f, :to_fld, :to_field. Finally, you can write :to =&gt; &#8216;field_name&#8217;,<br />
:to =&gt; &#8216;f:field_name&#8217; or :to =&gt; &#8216;v:variable_name&#8217;.</p>
<p>The &#8216;to&#8217; attribute instructs the iterator into which variable or field<br />
it should place the current value (the value being iterated over).</p>
<p>If there is no &#8216;to&#8217; specified, the current value is placed in the variable<br />
named &#8216;i&#8217;.</p>
<p>The variables &#8216;ii&#8217; contains the index (from 0 to &#8230;) of the current value<br />
(think Ruby&#8217;s #each_with_index).</p>
<p>The &#8216;on&#8217; attribute can be replaced by a :time or a :branches attribute.</p>
<pre class="brush: ruby">
  pdef = Ruote.process_definition :name =&gt; 'test' do
    iterator :times =&gt; '3' do
      participant 'accounting'
    end
  end
</pre>
<p>will be equivalent to</p>
<pre class="brush: ruby">
  pdef = Ruote.process_definition :name =&gt; 'test' do
    sequence do
      participant 'accounting'
      participant 'accounting'
      participant 'accounting'
    end
  end
</pre>
<h4>variables and scope</h4>
<p>Starting with ruote 2.3.0, the iterator doesn&#8217;t create a new scope for<br />
its variables, it uses the current scope.</p>
<p>The old behaviour can be obtained by setting :scope =&gt; true, as in:</p>
iterator :on =&gt; [ 1, 2, 3 ], :to_v =&gt; &#8216;x&#8217;, :scope =&gt; true do
<ol>
	<li>&#8230;<br />
    end</li>
</ol>
<p>A corollary: by default, the variables set by the iterator or within it<br />
stick in the current scope&#8230;</p>
<h3>the classical case</h3>
<p>Iterating over a workitem field:</p>
<pre class="brush: ruby">
  pdef = Ruote.process_definition :name =&gt; 'test' do
    iterator :on_field =&gt; 'customers', :to_f =&gt; 'customer'
      participant '${f:customer}'
    end
  end
</pre>
<p>It&#8217;s equivalent to:</p>
<pre class="brush: ruby">
  pdef = Ruote.process_definition :name =&gt; 'test' do
    iterator :on =&gt; '$f:customers', :to_f =&gt; 'customer'
      participant '${f:customer}'
    end
  end
</pre>
<p>&#8220;$f:customers&#8221; yields the actual array, whereas &#8220;${f:customers}&#8221;<br />
yields the string representation of the array.</p>
<h3>break/rewind/continue/skip/jump</h3>
<p>The &#8216;iterator&#8217; expression understands a certain the following commands :</p>
<ul>
	<li>break (_break) : exits the iteration</li>
	<li>rewind : places the iteration back at the first iterated value</li>
	<li>continue : same as &#8216;rewind&#8217;</li>
	<li>skip : skips a certain number of steps (relative)</li>
	<li>jump : jump to certain step (absolute)</li>
</ul>
<pre class="brush: ruby">
  pdef = Ruote.process_definition :name =&gt; 'test' do
    iterator :times =&gt; '3'
      sequence do
        participant 'accounting', :review =&gt; '${v:i}'
        rewind :if =&gt; '${f:redo_everything} == true'
      end
    end
  end
</pre>
<h3>iterator command in the workitem</h3>
<p>It&#8217;s OK to issue a command to the iterator from a participant via the<br />
workitem.</p>
<pre class="brush: ruby">
  pdef = Ruote.process_definition do
    iterator :times =&gt; 10
      sequence do
        participant 'accounting'
        participant 'adjust'
      end
    end
  end
</pre>
<p>where</p>
<pre class="brush: ruby">
  class Adjust
    include Ruote::LocalParticipant
    def consume(workitem)
      workitem.command = 'break' if workitem.fields['amount'] &gt; 10_000
      reply_to_engine(workitem)
    end
    def cancel(fei, flavour)
    end
  end
</pre>
<p>A completely stupid example&#8230; The adjust participant will make the<br />
loop break if the amount reaches 10_000 (euros?).</p>
<h3>break/rewind/continue/skip/jump with :ref</h3>
<p>An iterator can be tagged (with the :tag attribute) and directly referenced<br />
from a break/rewind/continue/skip/jump command.</p>
<p>It&#8217;s very useful when iterators (and cursors/loops) are nested within each<br />
other or when one has to act on an iterator from outside of it.</p>
<pre class="brush: ruby">
  concurrence do

    iterator :on =&gt; 'alpha, bravo, charly', :tag =&gt; 'review' do
      participant '${v:i}'
    end

    # meanwhile ...

    sequence do
      participant 'main control program'
      _break :ref =&gt; 'review', :if =&gt; '${f:cancel_review} == yes'
    end
  end
</pre>
<p>in this example, the participant &#8216;main control program&#8217; may cancel the<br />
review.</p>
<pre class="brush: ruby">
  iterator :on =&gt; 'c1, c2, c3', :to_f =&gt; 'client', :tag =&gt; 'main' do
    cursor do
      participant :ref =&gt; '${f:client}'
      _break :ref =&gt; 'main', :if =&gt; '${f:cancel_everything}'
      participant :ref =&gt; 'salesclerk'
      participant :ref =&gt; 'salesclerk'
    end
  end
</pre>
<p>in this weird process, if one customer says &#8220;cancel everything&#8221; (set the<br />
workitem field &#8220;cancel_everything&#8221; to true), then the whole iterator<br />
gets &#8216;broken&#8217; out of.</p>
</div>
</div>
</div>
</div>
<div id='footer'>
<div id='footer-center'>
<p>
<span id='footer-left'>
<a href='https://github.com/jmettraux/ruote_website/issues'>doc issue reporting</a>
|
<a href='https://github.com/jmettraux/ruote_website'>doc source</a>
| created with
<a href='http://nanoc.stoneship.org'>nanoc</a>
and
<a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
</span>
<span id='footer-right'>
&copy; 2005-2013 the ruote team
</span>
</p>
</div>
</div>
<script>
  SyntaxHighlighter.all();
</script>
</body>
</html>
