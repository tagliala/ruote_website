<!DOCTYPE html>
<html><head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<title>ruote - filter expression</title>
<script src='/ruote_website/js/shCore.js'></script>
<script src='/ruote_website/js/shBrushXml.js'></script>
<script src='/ruote_website/js/shBrushBash.js'></script>
<script src='/ruote_website/js/shBrushRuby.js'></script>
<script src='/ruote_website/js/shBrushJScript.js'></script>
<!-- %script{ :src => "/js/jquery-1.6.1.min.js" } -->
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
<link href='/ruote_website/css/reset.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shCore.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/shThemeRuote.css' rel='stylesheet' type='text/css'>
<link href='/ruote_website/css/ruote.css' rel='stylesheet' type='text/css'>
</head><body>
<div id='container'>
<div id='header'>
<div id='header-center'>
<div id='header-left'>
<a href='/ruote_website'>
<img src='/ruote_website/images/ruote.png'>
</a>
<div id='header-subtitle'>
a ruby workflow engine
</div>
</div>
<div id='header-right'>
<div id='nav'>
<span>
<a href='/ruote_website/documentation.html' title='documentation'>
doc
</a>
<a href='/ruote_website/source.html' title='source code'>
source
</a>
<a href='/ruote_website/download.html' title='download'>
download
</a>
<a class='nihongo' href='/ja.html' title='日本語'>
日本語
</a>
</span>
</div>
</div>
</div>
</div>
<div id='content'>
<div id='content-center'>
<div id='sidebar'><h3 onclick='document.location = &quot;/ruote_website/documentation.html&quot;' style='cursor: pointer'>
Documentation
</h3>
<ul>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branches
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/add_branches.html'>
add_branch
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/apply.html'>
apply
</a>
</li>
<li>
<a href='/ruote_website/exp/await.html'>
await
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
cancel_process
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
terminate
</a>
</li>
<li>
<a href='/ruote_website/exp/cancel_process.html'>
kill_process
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/command.html'>
command
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/command.html'>
skip
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
back
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
jump
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
rewind
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
continue
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
break
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
stop
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
over
</a>
</li>
<li>
<a href='/ruote_website/exp/command.html'>
reset
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/concurrence.html'>
concurrence
</a>
</li>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
concurrent_iterator
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/concurrent_iterator.html'>
citerator
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/cron.html'>
cron
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cron.html'>
every
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/cursor.html'>
cursor
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/cursor.html'>
loop
</a>
</li>
<li>
<a href='/ruote_website/exp/cursor.html'>
repeat
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/define.html'>
define
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/define.html'>
process_definition
</a>
</li>
<li>
<a href='/ruote_website/exp/define.html'>
workflow_definition
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/echo.html'>
echo
</a>
</li>
<li>
<a href='/ruote_website/exp/equals.html'>
equals
</a>
</li>
<li>
<a href='/ruote_website/exp/error.html'>
error
</a>
</li>
<li class='current'>
<a href='/ruote_website/exp/filter.html'>
filter
</a>
</li>
<li>
<a href='/ruote_website/exp/forget.html'>
forget
</a>
</li>
<li>
<a href='/ruote_website/exp/given.html'>
given
</a>
</li>
<li>
<a href='/ruote_website/exp/if.html'>
if
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
inc
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/inc.html'>
dec
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
increment
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
decrement
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
push
</a>
</li>
<li>
<a href='/ruote_website/exp/inc.html'>
pop
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/iterator.html'>
iterator
</a>
</li>
<li>
<a href='/ruote_website/exp/let.html'>
let
</a>
</li>
<li>
<a href='/ruote_website/exp/listen.html'>
listen
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/listen.html'>
receive
</a>
</li>
<li>
<a href='/ruote_website/exp/listen.html'>
intercept
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/lose.html'>
lose
</a>
</li>
<li>
<a href='/ruote_website/exp/noop.html'>
noop
</a>
</li>
<li>
<a href='/ruote_website/exp/on_error.html'>
on_error
</a>
</li>
<li>
<a href='/ruote_website/exp/once.html'>
once
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/once.html'>
when
</a>
</li>
<li>
<a href='/ruote_website/exp/once.html'>
as_soon_as
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/participant.html'>
participant
</a>
</li>
<li>
<a href='/ruote_website/exp/read.html'>
read
</a>
</li>
<li>
<a href='/ruote_website/exp/redo.html'>
redo
</a>
</li>
<li>
<a href='/ruote_website/exp/ref.html'>
ref
</a>
</li>
<li>
<a href='/ruote_website/exp/registerp.html'>
registerp
</a>
</li>
<li>
<a href='/ruote_website/exp/reserve.html'>
reserve
</a>
</li>
<li>
<a href='/ruote_website/exp/restore.html'>
restore
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/restore.html'>
set_fields
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/save.html'>
save
</a>
</li>
<li>
<a href='/ruote_website/exp/sequence.html'>
sequence
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/sequence.html'>
let
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/set.html'>
set
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/set.html'>
rset
</a>
</li>
<li>
<a href='/ruote_website/exp/set.html'>
unset
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/stall.html'>
stall
</a>
</li>
<li>
<a href='/ruote_website/exp/subprocess.html'>
subprocess
</a>
</li>
<li>
<a href='/ruote_website/exp/that.html'>
that
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/that.html'>
of
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/undo.html'>
undo
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/undo.html'>
cancel
</a>
</li>
<li>
<a href='/ruote_website/exp/undo.html'>
kill
</a>
</li>
</ul>
<li>
<a href='/ruote_website/exp/unregisterp.html'>
unregisterp
</a>
</li>
<li>
<a href='/ruote_website/exp/wait.html'>
wait
</a>
</li>
<ul class='alias'>
<li>
<a href='/ruote_website/exp/wait.html'>
sleep
</a>
</li>
</ul>
</ul>
<h3>
More
</h3>
<ul class='contact'>
<li>
<a href='https://github.com/jmettraux/ruote/tree/master/quickstart'>
quickstart
</a>
</li>
<li>
<a href='/ruote_website/presentations.html'>
presentations
</a>
</li>
<li>
<a href='/ruote_website/resources.html'>
resources
</a>
</li>
<li>
<a href='/ruote_website/users.html'>
users
</a>
</li>
</ul>
<h3>
Meta
</h3>
<ul class='contact'>
<li>
<a href='/ruote_website/source.html'>
source
</a>
</li>
<li>
<a href='/ruote_website/download.html'>
download
</a>
</li>
<li>
<a href='http://jmettraux.github.com'>
blog
</a>
</li>
<li>
<a href='/ruote_website/lists.html'>
mailing list
</a>
</li>
<li>
<a href='http://ruote-ci.s3.amazonaws.com/ci.html'>
continuous integration
</a>
</li>
<li>
<a href='http://ruote-irclogs.s3.amazonaws.com/logs.html'>
IRC
</a>
</li>
<li>
<a href='https://www.ohloh.net/p/ruote/'>
on ohloh
</a>
</li>
</ul>
<h3>
<span>
Search
</span>
</h3>
<ul class='contact'>
<li>
<form action='http://www.google.com/search' method='GET'>
<input id='qq' name='qq' style='' type='text'>
<input id='q' name='q' type='hidden'>
<input onclick='adjustSearch();' type='submit' value='search'>
</form>
</li>
</ul>
<script>
  function adjustSearch() {
    $('#q').val($('#qq').val() + ' site:http://ruote.rubyforge.org');
  }
</script>
</div>
<div id='content-main'>
<h2>filter</h2>
<p>Filter is a one-way filter expression. It filters workitem fields.<br />
Validations and Transformations are possible.</p>
<p>Validations will raise errors (that&#8217;ll block the process segment<br />
unless an :on_error attribute somehow deals with the problem).</p>
<p>Transformations will copy values around fields.</p>
<p>There are two ways to use it. With a single rule or with an array of<br />
rules.</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'string'
    # will raise an error if the field 'x' doesn't contain a String
</pre>
<p>or</p>
<pre class="brush: ruby">
  filter :in =&gt; [
    { :field =&gt; 'x', :type =&gt; 'string' },
    { :field =&gt; 'y', :type =&gt; 'number' }
  ]
</pre>
<p>For the remainder of this piece of documentation, the one rule filter<br />
will be used.</p>
<h3>filtering targets (field names)</h3>
<p>Top level field names are OK :</p>
<pre class="brush: ruby">
  filter 'customer_id', :type =&gt; 'string'
  filter 'invoice_id', :type =&gt; 'number'
</pre>
<p>Pointing to fields lying deeper is OK :</p>
<pre class="brush: ruby">
  filter 'customer.id', :type =&gt; 'number'
  filter 'customer.name', :type =&gt; 'string'
  filter 'invoice', :type =&gt; 'array'
  filter 'invoice.0.id', :type =&gt; 'number'
</pre>
<p>(Note the dollar notation is also OK with such dotted identifiers)</p>
<p>It&#8217;s possible to target multiple fields by passing a list of field names<br />
or a regular expression.</p>
<pre class="brush: ruby">
  filter 'city, region, country', :type =&gt; 'string'
    # will make sure that those 3 fields hold a string value

  filter '/^address\.x_/', :type =&gt; number
  filter '/^address!x_/', :type =&gt; number
    # fields whosename start with x_ in the address hash should be numbers
</pre>
<p>Note the &#8220;!&#8221; used as a shortcut for &#8220;\.&#8221; in the second line.</p>
<p>Passing a | separated list of field also works :</p>
<pre class="brush: ruby">
  filter 'city|region|country', :type =&gt; 'string'
    # will make sure that at least of one those field is present
    # any of the three that is present must hold a string

</pre>
<h3>validations</h3>
<h4>&#8216;type&#8217;</h4>
<p>Ruote is a Ruby library, it adopts Ruby &#8220;laissez-faire&#8221; for workitem<br />
fields, but sometimes, some type oriented validation is necessary.<br />
Ruote limits itself to the types found in the <span class="caps">JSON</span> specification with<br />
one or two additions.</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'string'
  filter 'x', :type =&gt; 'number'
  filter 'x', :type =&gt; 'bool'
  filter 'x', :type =&gt; 'boolean'
  filter 'x', :type =&gt; 'null'

  filter 'x', :type =&gt; 'array'

  filter 'x', :type =&gt; 'object'
  filter 'x', :type =&gt; 'hash'
    # 'object' and 'hash' are equivalent
</pre>
<p>It&#8217;s OK to pass multiple types for a field</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'bool,number'
  filter 'x', :type =&gt; [ 'string', 'array' ]

  filter 'x', :type =&gt; 'string,null'
    # a string or null or not set
</pre>
<p>The array and the object/hash types accept a subtype for their values<br />
(a hash/object must have string keys anyway).</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'array&lt;number&gt;'
  filter 'x', :type =&gt; 'array&lt;string&gt;'
  filter 'x', :type =&gt; 'array&lt;array&lt;string&gt;&gt;'

  filter 'x', :type =&gt; 'array&lt;string,number&gt;'
    # an array of strings or numbers (both)
  filter 'x', :type =&gt; 'array&lt;string&gt;,array&lt;number&gt;'
    # an array of strings or an array of numbers
</pre>
<h4>&#8216;match&#8217; and &#8216;smatch&#8217;</h4>
<p>&#8216;match&#8217; will check if a field, when turned into a string, matches<br />
a given regular expression.</p>
<pre class="brush: ruby">
  filter 'x', :match =&gt; '1'
    # will match "11", 1, 1.0, "212"
</pre>
<p>&#8216;smatch&#8217; works the same but only accepts fields that are strings.</p>
<pre class="brush: ruby">
  filter 'x', :smatch =&gt; '^user_'
    # valid only if x's value is a string that starts with "user_"
</pre>
<h4>&#8216;size&#8217; and &#8216;empty&#8217;</h4>
<p>&#8216;size&#8217; is valid for values that respond to the #size method (strings<br />
hashes and arrays).</p>
<pre class="brush: ruby">
  filter 'x', :size =&gt; 4
    # will be valid of values like [ 1, 2, 3, 4 ], "toto" or
    # { 'a' =&gt; 1, 'b' =&gt; 2, 'c' =&gt; 3, 'd' =&gt; 4 }

  filter 'x', :size =&gt; [ 4, 5 ]
  filter 'x', :size =&gt; '4,5'
    # four to five elements

  filter 'x', :size =&gt; [ 4 ]
  filter 'x', :size =&gt; [ 4, nil ]
  filter 'x', :size =&gt; '4,'
    # four or more elements

  filter 'x', :size =&gt; [ nil, 4 ]
  filter 'x', :size =&gt; ',4'
    # four elements or less
</pre>
<p>Similarly, the &#8216;empty&#8217; check will evaluate to true (ie not raise an<br />
exception) if the value responds to #empty? and is, well, not empty.</p>
<pre class="brush: ruby">
  filter 'x', :empty =&gt; true
</pre>
<h4>&#8216;is&#8217;</h4>
<p>Checks if a field holds the given value.</p>
<pre class="brush: ruby">
  filter 'x', :is =&gt; true
  filter 'x', :is =&gt; [ 'a', 2, 3 ]
</pre>
<h4>&#8216;in&#8217;</h4>
<p>Checks if a value is in a given set of values.</p>
<pre class="brush: ruby">
  filter 'x', :in =&gt; [ 1, 2, 3 ]
  filter 'x', :in =&gt; "john, jeff, jim"
</pre>
<h4>&#8216;has&#8217;</h4>
<p>Checks if an array contains certain values</p>
<pre class="brush: ruby">
  filter 'x', :has =&gt; 1
  filter 'x', :has =&gt; "x"
  filter 'x', :has =&gt; [ 1, 7, 12 ]
  filter 'x', :has =&gt; "abraham, bob, charly"
</pre>
<p>Also checks if a hash has certain keys (strings only of course)</p>
<pre class="brush: ruby">
  filter 'x', :has =&gt; "x"
  filter 'x', :has =&gt; "abraham, bob, charly"
</pre>
<h4>&#8216;includes&#8217;</h4>
<p>Checks if an array includes a given value. Works with Hash values as well.</p>
<pre class="brush: ruby">
  filter 'x', :includes =&gt; 1
</pre>
<p>Whereas &#8216;has&#8217; accepts multiple values, &#8216;includes&#8217; only accepts one (like<br />
Ruby&#8217;s Array#include?).</p>
<h4>&#8216;valid&#8217;</h4>
<p>Sometimes, it&#8217;s better to immediately say &#8216;true&#8217; or &#8216;false&#8217;.</p>
<pre class="brush: ruby">
  filter 'x', :valid =&gt; 'true'
  filter 'x', :valid =&gt; 'false'
</pre>
<p>Not very useful&#8230;</p>
<p>In fact, it&#8217;s meant to be used with the dollar notation</p>
<pre class="brush: ruby">
  filter 'x', :valid =&gt; '${other.field}'
    # will be valid if ${other.field} evaluates to 'true'...
</pre>
<h4>cumulating validations</h4>
<p>As seen before, type validations can be cumulated.</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'bool,number'
</pre>
<p>Validations can be cumulated as well</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'array&lt;number&gt;', :has =&gt; [ 1, 2 ]
    # will be valid if the field 'x' holds an array of numbers
    # and that array has 1 and 2 among its elements
</pre>
<h4>validation errors</h4>
<p>By defaults a validation error will result in a process error (ie the<br />
process instance will have to be manually fixed and resumed, or there<br />
is a :on_error somewhere dealing automatically with errors).</p>
<p>It&#8217;s possible to prevent raising an error and simply record the validation<br />
errors.</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'bool,number', :record =&gt; true
</pre>
<p>will enumerate validation errors in the &#8216;<i>validation_errors</i>&#8217; workitem<br />
field.</p>
<pre class="brush: ruby">
  filter 'y', :type =&gt; 'bool,number', :record =&gt; 'verrors'
</pre>
<p>will enumerate validation errors in teh &#8216;verrors&#8217; workitem field.</p>
<p>To flush the recording field, use :flush =&gt; true</p>
<pre class="brush: ruby">
  sequence do
    filter 'x', :type =&gt; 'string', :record =&gt; true
    filter 'y', :type =&gt; 'number', :record =&gt; true, :flush =&gt; true
    participant 'after'
  end
</pre>
<p>the participant &#8216;after&#8217; will only see the result of the second filter.</p>
<p>For complex filters, if the first rule has :record =&gt; true, the<br />
&#8216;recording&#8217; will happen for the whole filter.</p>
<pre class="brush: ruby">
  sequence do
    filter :in =&gt; [
      { :field =&gt; 'x', :type =&gt; 'string', :record =&gt; true },
      { :field =&gt; 'y', :type =&gt; 'number' } ]
    participant 'after'
  end

</pre>
<h3>transformations</h3>
<p>So far, only the validation aspect of filter was shown. They can also be<br />
used to transform the workitem.</p>
<pre class="brush: ruby">
  filter 'x', :type =&gt; 'string', :or =&gt; 'missing'
    # will replace the value of x by 'missing' if it's not a string

  filter 'z', :remove =&gt; true
    # will remove the workitem field z

  filter 'a,b,c', 'set' =&gt; '---'
    # sets the field a, b and c to '---'
</pre>
<h4>&#8216;remove&#8217;</h4>
<p>Removes a field (or a subfield).</p>
<pre class="brush: ruby">
  filter 'z', :remove =&gt; true
</pre>
<h4>&#8216;default&#8217;</h4>
<p>If there is no value for a field, sets it</p>
<pre class="brush: ruby">
  filter 'x', 'default' =&gt; 0
    # will set x to 0, if it's not set or its value is nil

  filter '/^user-.+/', 'default' =&gt; 'nemo'
    # will set any 'user-...' field to 'nemo' if its value is nil
</pre>
<h4>&#8216;or&#8217;</h4>
<p>&#8216;or&#8217; combines with a condition. The &#8216;or&#8217; value is set if the condition<br />
evaluates to false.</p>
<p>Using &#8216;or&#8217; without a condition makes it equivalent to a &#8216;default&#8217;.</p>
<pre class="brush: ruby">
  filter 'x', 'or' =&gt; 0
    # will set x to 0, if it's not set or its value is nil

  filter 'x', 'type' =&gt; 'number', 'or' =&gt; 0
    # if x is not set or is not a number, will set it to 0
</pre>
<p>Multiple conditions are OK</p>
<pre class="brush: ruby">
  filter 'x', 't' =&gt; 'array', 'has' =&gt; 'cat', 'or' =&gt; []
    # if x is an array and has the 'cat' element, nothing will happen.
    # Else x will be set to [].
</pre>
<h4>&#8216;and&#8217;</h4>
<p>&#8216;and&#8217; is much like &#8216;or&#8217;, but it triggers if the condition evaluates to true.</p>
<pre class="brush: ruby">
  filter 'x', 'type' =&gt; number, 'and' =&gt; '*removed*'
    # if x is a number, it will replace it with '*removed*'
</pre>
<h4>&#8216;set&#8217;</h4>
<p>Like &#8216;remove&#8217; removes unconditionally, &#8216;set&#8217; sets a field unconditionally.</p>
<pre class="brush: ruby">
  filter 'x', 'set' =&gt; 'blue'
    # sets the field x to 'blue'
</pre>
<h4>copy, merge, migrate / to, from</h4>
<pre class="brush: ruby">
  # in :   { 'x' =&gt; 'y' }
  filter 'x', 'copy_to' =&gt; 'z'
  # out :  { 'x' =&gt; 'y', 'z' =&gt; 'y' }

  # in :   { 'x' =&gt; 'y' }
  filter 'z', 'copy_from' =&gt; 'x'
  # out :  { 'x' =&gt; 'y', 'z' =&gt; 'y' }

  # in :   { 'x' =&gt; 'y' }
  filter 'z', 'copy_from' =&gt; 'x'
  # out :  { 'x' =&gt; 'y', 'z' =&gt; 'y' }

  # in :   { 'a' =&gt; %w[ x y ]})
  filter '/a\.(.+)/', 'copy_to' =&gt; 'b\1'
  # out :  { 'a' =&gt; %w[ x y ], 'b0' =&gt; 'x', 'b1' =&gt; 'y' },

  # in :   { 'a' =&gt; %w[ x y ]})
  filter '/a!(.+)/', 'copy_to' =&gt; 'b\1'
  # out :  { 'a' =&gt; %w[ x y ], 'b0' =&gt; 'x', 'b1' =&gt; 'y' },
    #
    # '!' is used as a replacement for '\.' in regexes

  # in :   { 'a' =&gt; 'b', 'c' =&gt; 'd', 'source' =&gt; [ 7 ] })
  filter '/^.$/', 'copy_from' =&gt; 'source.0'
  # out :  { 'a' =&gt; 7, 'c' =&gt; 7, 'source' =&gt; [ 7 ] },
</pre>
<p>&#8230;</p>
<p>&#8216;copy_to&#8217; and &#8216;copy_from&#8217; copy whole fields. &#8216;move_to&#8217; and &#8216;move_from&#8217;<br />
move fields.</p>
<p>&#8216;merge_to&#8217; and &#8216;merge_from&#8217; merge hashes (or add values to<br />
arrays), &#8216;push_to&#8217; and &#8216;push_from&#8217; are aliases for &#8216;merge_to&#8217; and<br />
&#8216;merge_from&#8217; respectively.</p>
<p>&#8216;migrate_to&#8217; and &#8216;migrate_from&#8217; act like &#8216;merge_to&#8217; and &#8216;merge_from&#8217; but<br />
delete the merge source afterwards (like &#8216;move&#8217;).</p>
<p>All those hash/array filter operations understand the &#8216;.&#8217; field, meaning<br />
the hash being filtered itself.</p>
<pre class="brush: ruby">
  # in :   { 'x' =&gt; { 'a' =&gt; 1, 'b' =&gt; 2 } })
  filter 'x', 'merge_to' =&gt; '.'
  # out :  { 'x' =&gt; { 'a' =&gt; 1, 'b' =&gt; 2 }, 'a' =&gt; 1, 'b' =&gt; 2 },
</pre>
<h4>access to &#8216;previous versions&#8217; with ~ and ~~</h4>
<p>Before a filter is applied, a copy of the hash to filter is placed under<br />
the &#8216;~&#8217; key in the hash itself.</p>
<p>this filter will at first set the field x to 0, and then reset it to its<br />
original value :</p>
<pre class="brush: ruby">
  filter :in =&gt; [
    { :field =&gt; 'x', :set =&gt; 0 },
    { :field =&gt; 'x', :copy_from =&gt; '~.x' }
  ]
</pre>
<p>For the &#8216;filter&#8217; expression, &#8216;~~&#8217; contains the same thing as &#8216;~&#8217;, but<br />
for the :filter attribute, it contains the hash (workitem fields) as<br />
it was when the expression with the :filter attribute got reached (applied).</p>
<h4>&#8216;restore&#8217; and &#8216;restore_from&#8217;</h4>
<p>Since these two filter operations leverage &#8216;~~&#8217;, they&#8217;re not very useful<br />
for the &#8216;filter&#8217; expression. But they make lots of sense for the :filter<br />
attribute.</p>
<pre class="brush: ruby">
  # in :   { 'x' =&gt; 'a', 'y' =&gt; 'a' },
  filter :in =&gt; [
    { 'field' =&gt; 'x', 'set' =&gt; 'X' },
    { 'field' =&gt; 'y', 'set' =&gt; 'Y' },
    { 'field' =&gt; '/^.$/', 'restore' =&gt; true } ]
  # out :   { 'x' =&gt; 'a', 'y' =&gt; 'a' },

  # in :   { 'x' =&gt; 'a', 'y' =&gt; 'a' },
  filter :in =&gt; [
    { 'field' =&gt; 'A', 'set' =&gt; {} },
    { 'field' =&gt; '.', 'merge_to' =&gt; 'A' },
    { 'field' =&gt; 'x', 'set' =&gt; 'X' },
    { 'field' =&gt; 'y', 'set' =&gt; 'Y' },
    { 'field' =&gt; '/^[a-z]$/', 'restore_from' =&gt; 'A' },
    { 'field' =&gt; 'A', 'delete' =&gt; true } ]
  # out :  { 'x' =&gt; 'a', 'y' =&gt; 'a' })
</pre>
<h4>&#8216;take&#8217; and &#8216;discard&#8217;</h4>
<p>(doesn&#8217;t work well with the filter expression, it works better with<br />
filter as an attribute)</p>
<p>Those two only make sense in out filters. One should use one or the other in<br />
a filter, but not both. It&#8217;s probably better to use them at the bottom of<br />
the filters (last positions), because they switch the applied workitem<br />
(apply time) with the current workitem (reply time).</p>
<p>&#8216;take&#8217; means &#8220;the fields to consider are the one in the applied workitem<br />
plus the ones from the new workitem listed here&#8221;.</p>
<p>&#8216;discard&#8217; means &#8220;the fields to consider are the the ones of the applied<br />
workitem plus all the ones from the new workitem except those listed here&#8221;.</p>
<pre class="brush: ruby">
  subprocess 'list_products', :filter =&gt; { :out =&gt; [
    { 'field' =&gt; 'products', 'take' =&gt; true },
    { 'field' =&gt; 'point_of_contact', 'take' =&gt; true }
  ] }
    # whatever the fields set by 'list_products', only 'products' and
    # 'point_of_contact' make it through
</pre>
<p>Saying :discard =&gt; true means &#8220;completely ignore any workitem field set<br />
by this expression&#8221;.</p>
<pre class="brush: ruby">
  subprocess 'review_document', :discard =&gt; true

</pre>
<h3>short forms</h3>
<p>Could help make filters a bit more compact.</p>
<ul>
	<li>&#8216;size&#8217;, &#8216;sz&#8217;</li>
	<li>&#8216;empty&#8217;, &#8216;e&#8217;</li>
	<li>&#8216;in&#8217;, &#8216;i&#8217;</li>
	<li>&#8216;has&#8217;, &#8216;h&#8217;</li>
	<li>&#8216;type&#8217;, &#8216;t&#8217;</li>
	<li>&#8216;match&#8217;, &#8216;m&#8217;</li>
	<li>&#8216;smatch&#8217;, &#8216;sm&#8217;</li>
	<li>&#8216;valid&#8217;, &#8216;v&#8217;</li>
</ul>
<ul>
	<li>&#8216;remove&#8217;, &#8216;rm&#8217;, &#8216;delete&#8217;, &#8216;del&#8217;</li>
	<li>&#8216;set&#8217;, &#8216;s&#8217;</li>
	<li>&#8216;copy_to&#8217;, &#8216;cp_to&#8217;</li>
	<li>&#8216;move_to&#8217;, &#8216;mv_to&#8217;</li>
	<li>&#8216;merge_to&#8217;, &#8216;mg_to&#8217;</li>
	<li>&#8216;migrate_to&#8217;, &#8216;mi_to&#8217;</li>
	<li>&#8216;restore&#8217;, &#8216;restore_from&#8217;, &#8216;rs&#8217;</li>
</ul>
<h3>top-level &#8216;or&#8217;</h3>
<p>Filters may be used to transform hashes or to validate them. In both cases<br />
the filters seen until now were like chained by a big <span class="caps">AND</span>.</p>
<p>It&#8217;s OK to write</p>
<pre class="brush: ruby">
  filter :in =&gt; [
    { 'field' =&gt; 'server_href', 'smatch' =&gt; '^https?:\/\/' },
    'or',
    { 'field' =&gt; 'nickname', 'type' =&gt; 'string' } ]
</pre>
<p>Granted, this is mostly for validation purposes, but it also works<br />
with transformations (as soon as an &#8216;or&#8217; child succeeds it&#8217;s returned<br />
and the other children are not evaluated).</p>
<h3>compared to the :filter attribute</h3>
<p>The :filter attribute accepts participant names, but for this filter<br />
expression, it makes no sense accepting partipants&#8230; Simply invoke<br />
the participant as usual.</p>
<p>The &#8216;restore&#8217; operation makes lots of sense for the :filter attribute<br />
though.</p>
<h3>filtering with rules in a block</h3>
<p>This filter</p>
<pre class="brush: ruby">
  filter :in =&gt; [
    { :field =&gt; 'x', :type =&gt; 'string' },
    { :field =&gt; 'y', :type =&gt; 'number' }
  ]
</pre>
<p>can be rewritten as</p>
<pre class="brush: ruby">
  filter do
    field 'x', :type =&gt; 'string'
    field 'y', :type =&gt; 'number'
  end
</pre>
<p>The field names can be passed directly as head of each rule :</p>
<pre class="brush: ruby">
  filter do
    x :type =&gt; 'string'
    y :type =&gt; 'number'
  end
</pre>
</div>
</div>
</div>
</div>
<div id='footer'>
<div id='footer-center'>
<p>
<span id='footer-left'>
<a href='https://github.com/jmettraux/ruote_website/issues'>doc issue reporting</a>
|
<a href='https://github.com/jmettraux/ruote_website'>doc source</a>
| created with
<a href='http://nanoc.stoneship.org'>nanoc</a>
and
<a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
</span>
<span id='footer-right'>
&copy; 2005-2013 the ruote team
</span>
</p>
</div>
</div>
<script>
  SyntaxHighlighter.all();
</script>
</body>
</html>
